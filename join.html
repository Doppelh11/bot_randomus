<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å ‚Äî —Ä–æ–∑—ã–≥—Ä—ã—à</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{ 
      --bg:#0a0d14; --card:#0f1627; --text:#f0f4ff; --muted:#9fb0cc; 
      --ok:#34d399; --err:#ff7b7b; --ring:#243049; 
      --neon:#7aa2ff; --gold:#ffd166; --pink:#ff6ad5; --mint:#56f0c9; --vio:#8b5cf6; --cyan:#22d3ee;
    }
    html,body{height:100%}
    body{margin:0; background:radial-gradient(1200px 600px at 50% -10%, #10162c 0%, #090d16 60%, #070a12 100%); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .wrap{max-width:820px;margin:0 auto;padding:24px}
    .card{background:linear-gradient(180deg,rgba(20,30,55,.9),rgba(14,20,36,.92));border-radius:22px;padding:24px;box-shadow:0 20px 80px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.05)}
    h1{margin:0 0 6px;font-size:22px}
    .muted{color:var(--muted)}

    /* Roulette */
    .roulette-wrap{position:relative;margin-top:18px;height:340px}
    .glow{position:absolute;inset:-20px;filter:blur(40px);background:conic-gradient(from 0deg, rgba(122,162,255,.15), rgba(34,211,238,.08), rgba(139,92,246,.12), rgba(86,240,201,.08), rgba(122,162,255,.15));border-radius:28px;pointer-events:none}
    .wheel-box{position:absolute;left:50%;top:10px;transform:translateX(-50%);width:320px;height:320px;border-radius:50%;background:radial-gradient(closest-side,#122041,#0b142a);display:grid;place-items:center;box-shadow:0 20px 60px rgba(0,0,0,.55), inset 0 0 0 10px #0d1a37, inset 0 0 0 16px #1e2c4c}
    .wheel{width:280px;height:280px;border-radius:50%;overflow:hidden;position:relative;box-shadow:inset 0 0 50px rgba(0,0,0,.35)}
    .marker{position:absolute;left:50%;top:-2px;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:18px solid var(--gold);filter:drop-shadow(0 2px 2px rgba(0,0,0,.5)) drop-shadow(0 0 8px rgba(255,209,102,.6))}
    .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:76px;height:76px;border-radius:50%;background:radial-gradient(circle at 35% 30%, #fff 0 2px, #9bb8ff 12%, #6ea0ff 60%, #3a65ff 100%);box-shadow:0 6px 18px rgba(122,162,255,.6), inset 0 0 12px rgba(255,255,255,.8)}
    .label{position:absolute;left:50%;bottom:8px;transform:translateX(-50%);font-weight:800;letter-spacing:.2px;text-shadow:0 1px 0 rgba(0,0,0,.4)}

    /* Segments */
    .seg{position:absolute;left:0;top:0;width:100%;height:100%;clip-path:polygon(50% 50%, 100% 50%, 100% 0, 50% 0);transform-origin:50% 50%;box-shadow:inset 0 0 20px rgba(0,0,0,.25)}
    /* —è—Ä–∫–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
    .seg:nth-child(6n+1){background:linear-gradient(180deg,#274c9a,#163274)}
    .seg:nth-child(6n+2){background:linear-gradient(180deg,#0b8ab5,#0a5f86)}
    .seg:nth-child(6n+3){background:linear-gradient(180deg,#7d30d8,#4d1fa1)}
    .seg:nth-child(6n+4){background:linear-gradient(180deg,#13c8a8,#0e8e7a)}
    .seg:nth-child(6n+5){background:linear-gradient(180deg,#ff7ab2,#db4e8a)}
    .seg:nth-child(6n+6){background:linear-gradient(180deg,#ffbe4d,#d68f19)}
    .seg b{position:absolute;right:10px;top:10px;font-size:12px;color:#e6edff;opacity:.8;text-shadow:0 1px 0 rgba(0,0,0,.5)}

    /* Spinner state */
    .spin{animation:spin 2600ms cubic-bezier(.17,.84,.21,1) forwards}
    @keyframes spin{0%{transform:rotate(0)}80%{transform:rotate(1100deg)}100%{transform:rotate(1090deg)}}

    /* Progress ring for checks */
    .ring{position:relative;width:84px;height:84px;margin:20px auto;border-radius:50%;box-shadow:inset 0 0 0 6px var(--ring)}
    .ring .seg-ok{position:absolute;inset:-6px;border-radius:50%;background:conic-gradient(var(--ok) 0deg, transparent 0deg);filter:drop-shadow(0 0 8px rgba(52,211,153,.35))}

    .result{display:none;margin-top:16px;text-align:center}
    .result.ok{display:block}
    .result .big{font-weight:900;font-size:18px}

    .need{display:none;margin-top:12px;text-align:center}
    .need.show{display:block}
    .need a{color:#a8c0ff;margin:0 6px;text-decoration:none;border-bottom:1px dashed rgba(168,192,255,.5)}

    .actions{display:flex;gap:8px;margin-top:14px}
    .btn{flex:1;border-radius:14px;border:1px solid #2a3247;background:linear-gradient(180deg,#162239,#0f182b);color:var(--text);padding:12px;font-weight:700;cursor:pointer;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.35)}

    /* Confetti canvas overlays */
    #fx{position:fixed;inset:0;pointer-events:none}
  </style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="wrap">
    <div class="card">
      <div class="glow"></div>
      <h1>üé∞ –£—á–∞—Å—Ç–∏–µ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è‚Ä¶</h1>
      <div class="muted">–†–æ–∑—ã–≥—Ä—ã—à <span id="gid">#‚Ä¶</span> ¬∑ –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è</div>

      <div class="roulette-wrap">
        <div class="wheel-box">
          <div class="marker"></div>
          <div id="wheel" class="wheel"></div>
          <div class="center"></div>
          <div class="label" id="label">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏‚Ä¶</div>
        </div>
      </div>

      <div id="ring" class="ring" aria-hidden="true"><div id="ringOk" class="seg-ok"></div></div>

      <div id="need" class="need"></div>

      <div id="resultOk" class="result">
        <div class="big">‚úÖ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –≤—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!</div>
        <div class="muted" id="afterText">–ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚Äî –±–æ—Ç –Ω–∞–ø–∏—à–µ—Ç, —á—Ç–æ –µ—â—ë –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å.</div>
        <div class="actions">
          <a class="btn" id="openBot">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
          <a class="btn" id="share">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥—É</a>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const WebApp = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  WebApp && (WebApp.ready(), WebApp.expand(), WebApp.disableVerticalSwipes && WebApp.disableVerticalSwipes());

  const BOT_USERNAME = 'deepseekrbot';
  // –£–∫–∞–∂–∏ –∞–¥—Ä–µ—Å —Å–≤–æ–µ–≥–æ API (–±–æ—Ç–∞). –ï—Å–ª–∏ –Ω–∞ —Ç–æ–º –∂–µ –¥–æ–º–µ–Ω–µ ‚Äî –º–æ–∂–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å.
  const API_JOIN = 'https://YOUR-SERVER/api/join';

  const qs = new URLSearchParams(location.search);
  const startParam = (WebApp && WebApp.initDataUnsafe && WebApp.initDataUnsafe.start_param) || qs.get('tgWebAppStartParam') || '';
  const gidMatch = /gid-(\d+)/.exec(startParam || '');
  const gid = gidMatch ? gidMatch[1] : null;
  const gidEl = document.getElementById('gid');
  gidEl.textContent = gid ? ('#' + gid) : '#‚Äî';

  const wheel = document.getElementById('wheel');
  const label = document.getElementById('label');
  const ring = document.getElementById('ring');
  const ringOk = document.getElementById('ringOk');
  const needBox = document.getElementById('need');
  const res = document.getElementById('resultOk');
  const openBot = document.getElementById('openBot');
  const share = document.getElementById('share');

  // Confetti
  const fx = document.getElementById('fx');
  const ctx = fx.getContext('2d');
  let confetti = [], rafId = 0, startTs = 0;
  function resize(){ fx.width = window.innerWidth; fx.height = window.innerHeight; }
  window.addEventListener('resize', resize); resize();
  function spawnConfetti(n=180){
    confetti = new Array(n).fill(0).map(()=>({
      x: Math.random()*fx.width,
      y: -20 - Math.random()*fx.height*0.2,
      r: 6+Math.random()*6,
      a: Math.random()*Math.PI*2,
      s: 1.5+Math.random()*2.2,
      c: [ '#ffd166','#7aa2ff','#22d3ee','#8b5cf6','#56f0c9','#ff6ad5' ][Math.floor(Math.random()*6)],
      spin: (Math.random()*.1+.05) * (Math.random()<.5?-1:1)
    }));
  }
  function drawConfetti(ts){
    if(!startTs) startTs = ts; const t = (ts-startTs)/1000; // seconds
    ctx.clearRect(0,0,fx.width,fx.height);
    confetti.forEach(p=>{
      p.y += p.s*3; p.x += Math.sin(p.a+=0.02)*1.2; p.r += p.spin;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
      ctx.fillStyle = p.c; ctx.fillRect(-4,-8,8,16);
      ctx.restore();
    });
    if (t < 3){ rafId = requestAnimationFrame(drawConfetti); } else { cancelAnimationFrame(rafId); startTs = 0; confetti=[]; ctx.clearRect(0,0,fx.width,fx.height); }
  }
  function blast(){ spawnConfetti(220); cancelAnimationFrame(rafId); startTs=0; rafId = requestAnimationFrame(drawConfetti); }

  function haptic(type){ try{ WebApp && WebApp.HapticFeedback && WebApp.HapticFeedback[type] && WebApp.HapticFeedback[type]('medium'); }catch{} }

  // --- build roulette segments (12 sectors) ---
  const SEGS = 12;
  for(let i=0;i<SEGS;i++){
    const s = document.createElement('div');
    s.className = 'seg';
    s.style.transform = `rotate(${(360/SEGS)*i}deg)`;
    const b = document.createElement('b');
    b.textContent = i%2? '√ó' : '‚úì';
    s.appendChild(b);
    wheel.appendChild(s);
  }

  function spin(){ wheel.classList.add('spin'); haptic('impactOccurred'); }
  function setRing(p){ ringOk.style.background = `conic-gradient(var(--ok) ${p*360}deg, transparent ${p*360}deg)`; }

  async function joinViaAPI(){
    const payload = { action: 'join', gid, init: WebApp && WebApp.initData || '' };
    const r = await fetch(API_JOIN, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      credentials: 'omit'
    });
    if(!r.ok) throw new Error('API ' + r.status);
    return await r.json(); // { ok, total, need?, reason? }
  }

  function showNeed(chans){
    needBox.innerHTML = '';
    if(!chans || !chans.length){ needBox.classList.remove('show'); return; }
    const title = document.createElement('div');
    title.textContent = '–£—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å:';
    needBox.appendChild(title);
    const row = document.createElement('div');
    (chans||[]).forEach(c=>{
      const a = document.createElement('a');
      a.textContent = c; a.href = `https://t.me/${c.replace('@','')}`; a.target = '_blank';
      a.addEventListener('click', e=>{
        e.preventDefault();
        const url = `https://t.me/${c.replace('@','')}`;
        if (WebApp && WebApp.openTelegramLink) WebApp.openTelegramLink(url); else window.open(url,'_blank');
      });
      row.appendChild(a);
    });
    needBox.appendChild(row);
    needBox.classList.add('show');
  }

  async function flow(){
    if (!gid){ label.textContent = '–ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∑–∞–ø—É—Å–∫–∞'; return; }
    // 1) spin
    spin();
    await new Promise(r=>setTimeout(r, 1300));
    ring.style.display = 'block';
    label.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è‚Ä¶';
    setRing(0.33); await new Promise(r=>setTimeout(r, 330));
    setRing(0.66); await new Promise(r=>setTimeout(r, 330));

    try{
      const data = await joinViaAPI();
      setRing(1);
      if (data.ok){
        haptic('notificationOccurred');
        label.textContent = '–ì–æ—Ç–æ–≤–æ!';
        needBox.classList.remove('show');
        res.classList.add('ok');
        blast(); // –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ üéâ
      } else {
        label.textContent = data.reason === 'conditions' ? '–ù—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è' : '–£—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã';
        showNeed(data.need);
      }
    }catch(e){
      label.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
    }
  }

  flow();

  openBot.addEventListener('click', ()=>{
    const url = `https://t.me/${BOT_USERNAME}`;
    if (WebApp && WebApp.openTelegramLink){ WebApp.openTelegramLink(url); }
    else { location.href = url; }
  });

  share.addEventListener('click', ()=>{
    const text = gid ? `–Ø —É—á–∞—Å—Ç–≤—É—é –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ #${gid}!` : '–Ø —É—á–∞—Å—Ç–≤—É—é –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!';
    if (navigator.share){ navigator.share({ text }); }
    else if (WebApp && WebApp.openTelegramLink){ WebApp.openTelegramLink(`https://t.me/share/url?text=${encodeURIComponent(text)}`); }
    else { alert(text); }
  });
})();
</script>
</body>
</html>
