<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å ‚Äî —Ä–æ–∑—ã–≥—Ä—ã—à</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#070a12; --card:#0e1627; --text:#eef3ff; --muted:#9fb0cc;
      --ok:#34d399; --err:#ff7b7b; --ring:#233049;
      --seg:#1f3a83; --divider:rgba(255,255,255,.14);
      --gold:#ffd166; --neon:#84a9ff; --cyan:#22d3ee; --vio:#8b5cf6;
    }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 680px at 50% -10%, #111934 0%, #0a0f1d 55%, #070a12 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .wrap{max-width:840px;margin:0 auto;padding:22px}
    .card{position:relative;background:linear-gradient(180deg,rgba(22,30,52,.92),rgba(12,18,34,.96));border-radius:22px;padding:22px;box-shadow:0 24px 80px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06)}
    .glow{position:absolute;inset:-20px;pointer-events:none;filter:blur(42px);opacity:.9;background:conic-gradient(from 0deg, rgba(132,169,255,.18), rgba(34,211,238,.08), rgba(139,92,246,.14), rgba(132,169,255,.18)) ;border-radius:28px}
    h1{margin:0 0 6px;font-size:22px}
    .muted{color:var(--muted)}

    /* Roulette */
    .roulette-wrap{position:relative;margin-top:18px;height:340px}
    .wheel-box{position:absolute;left:50%;top:8px;transform:translateX(-50%);width:320px;height:320px;border-radius:50%;background:radial-gradient(closest-side,#142752,#0e1a3a);display:grid;place-items:center;box-shadow:0 22px 60px rgba(0,0,0,.6), inset 0 0 0 12px #0e1c3b, inset 0 0 0 18px #1f2f54}
    .wheel{width:280px;height:280px;border-radius:50%;position:relative;box-shadow:inset 0 0 60px rgba(0,0,0,.35);background:
      repeating-conic-gradient(
        var(--seg) 0deg 14.5deg,
        var(--divider) 14.5deg 15deg
      );
    }
    .marker{position:absolute;left:50%;top:-2px;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:18px solid var(--gold);filter:drop-shadow(0 2px 2px rgba(0,0,0,.5)) drop-shadow(0 0 10px rgba(255,209,102,.6))}
    .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:78px;height:78px;border-radius:50%;background:radial-gradient(circle at 35% 30%, #fff 0 2px, #9bb8ff 12%, #6ea0ff 60%, #3a65ff 100%);box-shadow:0 6px 18px rgba(132,169,255,.6), inset 0 0 14px rgba(255,255,255,.85)}
    .label{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);font-weight:900;letter-spacing:.2px;text-shadow:0 1px 0 rgba(0,0,0,.4)}

    .spin{animation:spin 2600ms cubic-bezier(.17,.84,.21,1) forwards}
    @keyframes spin{0%{transform:rotate(0)}80%{transform:rotate(1100deg)}100%{transform:rotate(1090deg)}}

    /* Progress ring */
    .ring{position:relative;width:86px;height:86px;margin:18px auto;border-radius:50%;box-shadow:inset 0 0 0 6px var(--ring)}
    .ring .seg-ok{position:absolute;inset:-6px;border-radius:50%;background:conic-gradient(var(--ok) 0deg, transparent 0deg);filter:drop-shadow(0 0 8px rgba(52,211,153,.35))}

    .result{display:none;margin-top:14px;text-align:center}
    .result.ok{display:block}
    .result .big{font-weight:900;font-size:18px}

    .need{display:none;margin-top:12px;text-align:center}
    .need.show{display:block}
    .need a{color:#a8c0ff;margin:0 6px;text-decoration:none;border-bottom:1px dashed rgba(168,192,255,.55)}

    .actions{display:flex;gap:8px;margin-top:14px}
    .btn{flex:1;border-radius:14px;border:1px solid #2a3247;background:linear-gradient(180deg,#162239,#0f182b);color:var(--text);padding:12px;font-weight:800;cursor:pointer;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.35)}

    /* Confetti */
    #fx{position:fixed;inset:0;pointer-events:none}

    /* Banner for fallback mode */
    .banner{display:none;margin-top:10px;padding:10px;border-radius:12px;background:#0a1426;border:1px solid rgba(255,255,255,.08);color:#b8c7e8;font-size:12px}
    .banner.show{display:block}
  </style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="wrap">
    <div class="card">
      <div class="glow"></div>
      <h1>üé∞ –£—á–∞—Å—Ç–∏–µ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è‚Ä¶</h1>
      <div class="muted">–†–æ–∑—ã–≥—Ä—ã—à <span id="gid">#‚Ä¶</span> ¬∑ –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è</div>

      <div class="roulette-wrap">
        <div class="wheel-box">
          <div class="marker"></div>
          <div id="wheel" class="wheel"></div>
          <div class="center"></div>
          <div class="label" id="label">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏‚Ä¶</div>
        </div>
      </div>

      <div id="ring" class="ring" aria-hidden="true"><div id="ringOk" class="seg-ok"></div></div>

      <div id="need" class="need"></div>
      <div id="fallback" class="banner"></div>

      <div id="resultOk" class="result">
        <div class="big">‚úÖ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –≤—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!</div>
        <div class="muted" id="afterText">–ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚Äî –±–æ—Ç –ø–æ–¥—Å–∫–∞–∂–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å.</div>
        <div class="actions">
          <a class="btn" id="openBot">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
          <a class="btn" id="share">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥—É</a>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // === Telegram WebApp boot ===
  const WebApp = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  WebApp && (WebApp.ready(), WebApp.expand(), WebApp.disableVerticalSwipes && WebApp.disableVerticalSwipes());

  // === –ö–æ–Ω—Ñ–∏–≥ ===
  const BOT_USERNAME = 'deepseekrbot'; // <-- –∏–º—è —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞ –±–µ–∑ @
  const API_DEFAULT = 'https://bot-randomus-1.onrender.com/api/join'; // <-- —Ç–≤–æ–π –±–µ–∫–µ–Ω–¥ –Ω–∞ Render
  const apiParam = new URLSearchParams(location.search).get('api');
  const API = apiParam || API_DEFAULT; // –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ?api=...

  // === GID –∏–∑ start_param ===
  const qs = new URLSearchParams(location.search);
  const startParam = (WebApp && WebApp.initDataUnsafe && WebApp.initDataUnsafe.start_param) || qs.get('tgWebAppStartParam') || '';
  const gidMatch = /gid-(\d+)/.exec(startParam || '');
  const gid = gidMatch ? gidMatch[1] : null;
  document.getElementById('gid').textContent = gid ? ('#' + gid) : '#‚Äî';

  // === UI refs ===
  const wheel = document.getElementById('wheel');
  const label = document.getElementById('label');
  const ring = document.getElementById('ring');
  const ringOk = document.getElementById('ringOk');
  const needBox = document.getElementById('need');
  const res = document.getElementById('resultOk');
  const openBot = document.getElementById('openBot');
  const share = document.getElementById('share');
  const fallback = document.getElementById('fallback');

  // === Confetti ===
  const fx = document.getElementById('fx');
  const ctx = fx.getContext('2d');
  let confetti = [], rafId = 0, startTs = 0;
  function resize(){ fx.width = window.innerWidth; fx.height = window.innerHeight; }
  window.addEventListener('resize', resize); resize();
  function spawnConfetti(n=240){
    confetti = new Array(n).fill(0).map(()=>({
      x: Math.random()*fx.width,
      y: -20 - Math.random()*fx.height*0.2,
      r: 6+Math.random()*6,
      a: Math.random()*Math.PI*2,
      s: 1.6+Math.random()*2.2,
      c: [ '#ffd166','#84a9ff','#22d3ee','#8b5cf6','#34d399' ][Math.floor(Math.random()*5)],
      spin: (Math.random()*.12+.05) * (Math.random()<.5?-1:1)
    }));
  }
  function drawConfetti(ts){
    if(!startTs) startTs = ts; const t = (ts-startTs)/1000;
    ctx.clearRect(0,0,fx.width,fx.height);
    confetti.forEach(p=>{
      p.y += p.s*3.2; p.x += Math.sin(p.a+=0.02)*1.25; p.r += p.spin;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
      ctx.fillStyle = p.c; ctx.fillRect(-4,-8,8,16);
      ctx.restore();
    });
    if (t < 3){ rafId = requestAnimationFrame(drawConfetti); } else { cancelAnimationFrame(rafId); startTs = 0; confetti=[]; ctx.clearRect(0,0,fx.width,fx.height); }
  }
  function blast(){ spawnConfetti(260); cancelAnimationFrame(rafId); startTs=0; rafId = requestAnimationFrame(drawConfetti); }
  function haptic(type){ try{ WebApp && WebApp.HapticFeedback && WebApp.HapticFeedback[type] && WebApp.HapticFeedback[type]('medium'); }catch{} }

  // === UI helpers ===
  function spin(){ wheel.classList.add('spin'); haptic('impactOccurred'); }
  function setRing(p){ ringOk.style.background = `conic-gradient(var(--ok) ${p*360}deg, transparent ${p*360}deg)`; }
  function showNeed(chans){
    needBox.innerHTML = '';
    if(!chans || !chans.length){ needBox.classList.remove('show'); return; }
    const title = document.createElement('div');
    title.textContent = '–£—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å:';
    needBox.appendChild(title);
    const row = document.createElement('div');
    (chans||[]).forEach(c=>{
      const a = document.createElement('a');
      a.textContent = c; a.href = `https://t.me/${c.replace('@','')}`; a.target = '_blank';
      a.addEventListener('click', e=>{
        e.preventDefault();
        const url = `https://t.me/${c.replace('@','')}`;
        if (WebApp && WebApp.openTelegramLink) WebApp.openTelegramLink(url); else window.open(url,'_blank');
      });
      row.appendChild(a);
    });
    needBox.appendChild(row);
    needBox.classList.add('show');
  }

  // === API call ===
  async function joinViaAPI(){
    const payload = { action: 'join', gid, init: WebApp && WebApp.initData || '' };
    const ctrl = new AbortController();
    const to = setTimeout(()=>ctrl.abort(), 8000);
    try{
      const r = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        credentials: 'omit',
        signal: ctrl.signal
      });
      clearTimeout(to);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json(); // { ok, total, need?, reason? }
    }catch(e){ clearTimeout(to); throw e; }
  }

  // === Main flow ===
  async function flow(){
    if (!gid){ label.textContent = '–ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∑–∞–ø—É—Å–∫–∞'; return; }

    spin();
    await new Promise(r=>setTimeout(r, 1200));
    ring.style.display = 'block';
    label.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è‚Ä¶';
    setRing(0.33); await new Promise(r=>setTimeout(r, 330));
    setRing(0.66); await new Promise(r=>setTimeout(r, 330));

    // –ï—Å–ª–∏ API –ø—É—Å—Ç (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π) ‚Äî –º—è–≥–∫–∏–π fallback —á–µ—Ä–µ–∑ sendData
    if (!API){
      const warn = 'API URL –Ω–µ –∑–∞–¥–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É—é —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–± ‚Äî –±–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç —É—Å–ª–æ–≤–∏—è –≤ –õ–°.';
      fallback.textContent = warn; fallback.classList.add('show');
      try {
        const payload = { action:'join', gid, init: WebApp && WebApp.initData || '' };
        WebApp && WebApp.sendData && WebApp.sendData(JSON.stringify(payload));
        label.textContent = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –±–æ—Ç—É‚Ä¶';
        res.classList.add('ok');
        blast();
      } catch(e){
        label.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
      }
      return;
    }

    try{
      const data = await joinViaAPI();
      setRing(1);
      if (data.ok){
        haptic('notificationOccurred');
        label.textContent = '–ì–æ—Ç–æ–≤–æ!';
        needBox.classList.remove('show');
        res.classList.add('ok');
        blast(); // üéâ
      } else {
        label.textContent = data.reason === 'conditions' ? '–ù—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è' : '–£—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã';
        showNeed(data.need);
      }
    }catch(e){
      console.error('joinViaAPI failed', e);
      label.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
      const diag = document.createElement('div');
      diag.className = 'muted'; diag.style.fontSize = '12px'; diag.style.marginTop = '6px';
      diag.textContent = 'URL: '+API+' ‚Ä¢ –û—à–∏–±–∫–∞: '+(e && e.message ? e.message : 'network');
      needBox.after(diag);
    }
  }

  flow();

  // === Actions ===
  openBot.addEventListener('click', ()=>{
    const url = `https://t.me/${BOT_USERNAME}`;
    if (WebApp && WebApp.openTelegramLink){ WebApp.openTelegramLink(url); }
    else { location.href = url; }
  });

  share.addEventListener('click', ()=>{
    const text = gid ? `–Ø —É—á–∞—Å—Ç–≤—É—é –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ #${gid}!` : '–Ø —É—á–∞—Å—Ç–≤—É—é –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!';
    if (navigator.share){ navigator.share({ text }); }
    else if (WebApp && WebApp.openTelegramLink){ WebApp.openTelegramLink(`https://t.me/share/url?text=${encodeURIComponent(text)}`); }
    else { alert(text); }
  });
})();
</script>
</body>
</html>
