<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Join Giveaway</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #f5f5f5; padding: 14px; }
    pre { background: #eee; padding: 8px; border-radius: 6px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
    button { padding: 10px 14px; border: none; background: #4CAF50; color: white; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #607D8B; }
    button:hover { filter: brightness(0.95); }
    #result, #debug-result { white-space: pre-wrap; background: #fff; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ddd; }
    .muted { color: #666; font-size: 13px; }
    .ok { color: #2e7d32; }
    .err { color: #c62828; }
  </style>
</head>
<body>
  <h2>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —Ä–æ–∑—ã–≥—Ä—ã—à—É</h2>
  <div class="muted">–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ Telegram Mini App.</div>

  <pre id="diag"></pre>

  <div class="row">
    <button id="btnJoin">üéâ –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å</button>
    <button id="btnDebug" class="secondary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ /api/debug-init</button>
    <button id="btnCopy" class="secondary">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å initData</button>
  </div>

  <div id="result"></div>
  <div id="debug-result"></div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // –£–∫–∞–∂–∏ –±–∞–∑–æ–≤—ã–π API ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π URL —Ç–≤–æ–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
    const API_BASE = 'https://bot-randomus-1.onrender.com';

    const tg = window.Telegram?.WebApp;
    if (tg && tg.ready) tg.ready();

    const diag = document.getElementById('diag');
    const result = document.getElementById('result');
    const debugResult = document.getElementById('debug-result');

    const initData = tg?.initData || "";
    const initDataUnsafe = tg?.initDataUnsafe || {};
    const urlParams = new URLSearchParams(window.location.search);

    // gid –±–µ—Ä—ë–º –∏–∑ start_param (–∏–∑ Telegram) –∏–ª–∏ –∏–∑ query (?startapp=gid-123 / ?start=gid-123)
    const startParam = initDataUnsafe.start_param || urlParams.get('startapp') || urlParams.get('start') || '';
    const gid = (startParam || '').startsWith('gid-') ? (startParam || '').slice(4) : (startParam || '');

    const deepLinkUser = initDataUnsafe?.user?.username || 'YOUR_BOT';
    const deepLink = `https://t.me/${deepLinkUser}/myapp?startapp=gid-${gid}`;

    diag.textContent =
`WebApp?: ${!!tg?.initData}
initData length: ${initData.length}
start_param: ${startParam}
gid: ${gid}
API_BASE: ${API_BASE}
join endpoint: ${API_BASE}/api/join
debug endpoint: ${API_BASE}/api/debug-init
deepLink (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏): ${deepLink}`;

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ initData
    document.getElementById('btnCopy').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(initData);
        alert('initData —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
      } catch (e) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: ' + e);
      }
    });

    // –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
    document.getElementById('btnJoin').addEventListener('click', async () => {
      result.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      if (!gid) {
        result.innerHTML = '<span class="err">–ù–µ –Ω–∞–π–¥–µ–Ω gid (–ø—Ä–æ–≤–µ—Ä—å start_param)</span>';
        return;
      }
      try {
        const resp = await fetch(`${API_BASE}/api/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gid: Number(gid), init: initData })
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          result.innerHTML = `<span class="err">–û—à–∏–±–∫–∞ ${resp.status}: ${data?.reason || 'unknown'}</span>`;
          return;
        }
        if (data.ok) {
          result.innerHTML = `<span class="ok">–£—Å–ø–µ—Ö!</span> –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–µ–π—á–∞—Å: ${data.total}`;
        } else if (data.reason === 'conditions') {
          const need = (data.need || []).map(x => '‚Ä¢ ' + x).join('\n') || '-';
          result.innerHTML = `<span class="err">–ù—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è:</span>\n${need}`;
        } else {
          result.innerHTML = `<span class="err">–ù–µ —É–¥–∞–ª–æ—Å—å: ${data.reason || 'unknown'}</span>`;
        }
      } catch (err) {
        result.innerHTML = '<span class="err">–°–µ—Ç—å/–±—Ä–∞—É–∑–µ—Ä: ' + err + '</span>';
      }
    });

    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ initData
    document.getElementById('btnDebug').addEventListener('click', async () => {
      debugResult.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      try {
        const resp = await fetch(`${API_BASE}/api/debug-init`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ init: initData })
        });
        const text = await resp.text();
        debugResult.textContent = text;
      } catch (err) {
        debugResult.textContent = '–û—à–∏–±–∫–∞: ' + err;
      }
    });
  </script>
</body>
</html>
