<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hero-анимация — 7 слоёв + видео (ползунки всегда активны)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0c0d10; --fg:#fff; --muted:#b5b6bf; --maxw:1200px;

      /* ===== Переменные подгонки (сохраняйте и копируйте) ===== */
      --veo-shift-x: 0px;     /* смещение по X */
      --veo-shift-y: 0px;     /* смещение по Y */
      --veo-scale-x: 1;       /* масштаб по X */
      --veo-scale-y: 1;       /* масштаб по Y */
      --veo-rot: 0deg;        /* поворот */
      --veo-object-fit: fill; /* fill | cover | contain */
      --veo-objx: 50%;        /* object-position X (0–100%) */
      --veo-objy: 50%;        /* object-position Y (0–100%) */
      --veo-user-op: .35;     /* непрозрачность видео от пользователя (0–1) */
      /* --veo-anim-op мы не трогаем из UI — можно использовать для анимации, если понадобится */
      --veo-anim-op: 1;       /* множитель опацити от анимации (0–1) */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:radial-gradient(1200px 900px at 20% 20%, #171924 0, #0f1118 50%, #0c0d10 100%);
    }
    .wrap{max-width:var(--maxw); margin:auto; padding:clamp(20px,4vw,64px)}
    .hero{
      display:grid; grid-template-columns:1.1fr 0.9fr; align-items:center;
      gap:clamp(20px,5vw,80px); min-height:90svh;
    }
    @media (max-width:960px){
      .hero{grid-template-columns:1fr; min-height:auto}
      .copy{text-align:center; order:-1}
    }
    .copy h1{margin:0 0 .4em; line-height:1.05; font-weight:800; font-size:clamp(28px,6vw,62px); letter-spacing:-.02em}
    .copy p{margin:0 0 1.25rem; color:var(--muted); font-size:clamp(16px,2.3vw,20px)}
    .btn{
      appearance:none; border:none; background:#ffffff10; color:#fff;
      padding:12px 18px; border-radius:16px; font-weight:600; cursor:pointer;
      backdrop-filter:blur(6px); transition:transform .15s ease, background .2s ease;
    }
    .btn:hover{transform:translateY(-1px); background:#ffffff18}
    .btn:active{transform:translateY(0)}

    /* ===== Сцена ===== */
    .stage{
      position:relative; width:100%; max-width:760px;
      aspect-ratio: 2048 / 1828; /* точное соотношение исходников */
      margin-inline:auto; isolation:isolate;
      filter:drop-shadow(0 40px 120px rgba(0,0,0,.55));
      perspective:1200px; contain:layout paint;
    }
    .layer{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:contain; transform-style:preserve-3d; backface-visibility:hidden;
      will-change:transform,opacity,filter; opacity:0;
    }

    /* ===== Видео: всегда можно настраивать поверх (с прозрачностью) ===== */
    .veo{
      pointer-events:none;
      width:100%;
      height:100%;
      object-fit: var(--veo-object-fit);
      object-position: var(--veo-objx) var(--veo-objy);
      transform-origin: top left;
      will-change:opacity, transform;
      transform:
        translate(var(--veo-shift-x), var(--veo-shift-y))
        scale(var(--veo-scale-x), var(--veo-scale-y))
        rotate(var(--veo-rot));
      opacity: calc(var(--veo-user-op) * var(--veo-anim-op));
    }

    .hint{ text-align:center; color:#a7aab8; margin-top:22px; font-size:13px; opacity:.75 }

    /* ===== Панель ползунков: всегда видна ===== */
    .ui{
      position:fixed; right:16px; bottom:16px; width:min(460px, 94vw);
      background:#0e1016cc; color:#fff; border:1px solid #ffffff22; border-radius:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.5); backdrop-filter:blur(10px);
      padding:12px; z-index:9999;
    }
    .ui h3{ margin:0 0 8px; font-size:15px }
    .grid{ display:grid; grid-template-columns:1fr 92px; gap:10px; align-items:center }
    .row{ display:contents }
    .ui label{ font-size:12px; color:#c8cad7 }
    .ui input[type="range"]{ width:100% }
    .ui input[type="number"], .ui select{
      width:100%; padding:7px 8px; border-radius:8px; background:#151826; color:#fff; border:1px solid #ffffff28;
      font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .ui .actions{ display:flex; gap:8px; margin-top:10px }
    .ui .actions button{
      flex:1; padding:10px 12px; border-radius:10px; border:1px solid #ffffff22; background:#ffffff12; color:#fff; cursor:pointer;
    }
    .ui small{ display:block; margin-top:6px; color:#9aa0b6 }
    .row-full{ grid-column:1 / -1; display:flex; gap:10px; align-items:center; margin-top:8px }
    .row-full input[type="range"]{ flex:1 }
    .row-full .val{ width:42px; text-align:right; font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#c8cad7 }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero" id="hero">
      <div class="stage" id="stage" aria-hidden="true">
        <!-- 1) планшет -->
        <img class="layer device" src="assets/step1.png" alt="tablet frame">

        <!-- 2) 6 экранных слоёв -->
        <img class="layer s1" src="assets/step2.png" alt="">
        <img class="layer s2" src="assets/step3.png" alt="">
        <img class="layer s3" src="assets/step4.png" alt="">
        <img class="layer s4" src="assets/step5.png" alt="">
        <img class="layer s5" src="assets/step6.png" alt="">
        <img class="layer s6" src="assets/step7.png" alt="">

        <!-- 3) Финальное видео поверх -->
        <video class="layer veo" id="veo" muted playsinline preload="auto" poster="assets/step7.png">
          <source src="assets/veo.webm#t=0.001" type="video/webm">
          <source src="assets/veo.mp4#t=0.001"  type="video/mp4">
        </video>
      </div>

      <div class="copy">
        <h1>Анимация «сборки» — 7 слайдов + видео</h1>
        <p>Ползунки всегда доступны. Можно настраивать видео в любом положении анимации.</p>
        <button class="btn" id="playPause">Пауза</button>
        <button class="btn" id="replay">С начала</button>
        <div class="hint">Файлы в <code>assets/</code>. Настройки сохраняются в <code>localStorage</code>.</div>
      </div>
    </section>
  </div>

  <!-- Панель настроек -->
  <aside class="ui" aria-live="polite">
    <h3>Подгонка видео и позиция анимации</h3>
    <div class="grid">
      <div class="row">
        <label>Object-fit</label>
        <select id="fit">
          <option value="fill">fill (растянуть в рамки)</option>
          <option value="cover">cover (с кропом)</option>
          <option value="contain">contain (с полями)</option>
        </select>
      </div>
      <div class="row">
        <label>Object X (%)</label>
        <div><input type="number" id="objxNum" min="0" max="100" step="0.1"><input type="range" id="objx" min="0" max="100" step="0.1"></div>
      </div>
      <div class="row">
        <label>Object Y (%)</label>
        <div><input type="number" id="objyNum" min="0" max="100" step="0.1"><input type="range" id="objy" min="0" max="100" step="0.1"></div>
      </div>

      <div class="row">
        <label>X (px)</label>
        <div><input type="number" id="xNum" step="0.5"><input type="range" id="x" min="-80" max="80" step="0.5"></div>
      </div>
      <div class="row">
        <label>Y (px)</label>
        <div><input type="number" id="yNum" step="0.5"><input type="range" id="y" min="-80" max="80" step="0.5"></div>
      </div>
      <div class="row">
        <label>Scale X</label>
        <div><input type="number" id="sxNum" step="0.001"><input type="range" id="sx" min="0.98" max="1.05" step="0.001"></div>
      </div>
      <div class="row">
        <label>Scale Y</label>
        <div><input type="number" id="syNum" step="0.001"><input type="range" id="sy" min="0.98" max="1.05" step="0.001"></div>
      </div>
      <div class="row">
        <label>Rotate (deg)</label>
        <div><input type="number" id="rotNum" step="0.01"><input type="range" id="rot" min="-2" max="2" step="0.01"></div>
      </div>
      <div class="row">
        <label>Opacity</label>
        <div><input type="number" id="opNum" min="0" max="1" step="0.01"><input type="range" id="op" min="0" max="1" step="0.01"></div>
      </div>

      <div class="row-full">
        <label style="min-width:130px">Позиция анимации</label>
        <input type="range" id="progress" min="0" max="1000" step="1" title="Перемотка сцены">
        <div class="val"><span id="progVal">0</span>%</div>
      </div>
    </div>
    <div class="actions">
      <button id="copyCss">Скопировать CSS</button>
      <button id="reset">Сброс</button>
    </div>
    <small>Скролл «Позиция анимации» позволяет настраивать видео на любом шаге.</small>
  </aside>

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>
  <script>
  (() => {
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    const playPauseBtn = document.getElementById('playPause');
    const replayBtn = document.getElementById('replay');
    const layers = [...document.querySelectorAll('.layer')];
    const video  = document.getElementById('veo');

    /* ========= Предзагрузка ========= */
    const preloadImages = (srcs) => Promise.all(srcs.map(s => new Promise(res => {
      const im = new Image(); im.onload = im.onerror = () => res(); im.src = s;
    })));
    const preloadVideo = (v) => new Promise(res => {
      if (!v) return res();
      const ready = () => { v.removeEventListener('canplaythrough', ready); v.removeEventListener('loadeddata', ready); res(); };
      if (v.readyState >= 3) return res();
      v.addEventListener('canplaythrough', ready, { once:true });
      v.addEventListener('loadeddata', ready, { once:true });
      try { v.load(); } catch(e) {}
    });

    /* ========= Анимация ========= */
    let tl;
    function buildTimeline(){
      tl = gsap.timeline({ defaults:{ ease:'power3.out' } });
      gsap.set('.device', { opacity:0, yPercent:4, scale:0.985, rotateZ:-1, filter:'blur(6px)' });
      gsap.set(['.s1','.s2','.s3','.s4','.s5','.s6'], { opacity:0, yPercent:3, rotateX:4, rotateZ:-1, scale:0.99 });

      tl.to('.device', { opacity:1, yPercent:0, scale:1, rotateZ:0, filter:'blur(0px)', duration:0.55, ease:'back.out(1.6)' });

      ['.s1','.s2','.s3','.s4','.s5','.s6'].forEach((sel, i) => {
        tl.to(sel, { opacity:1, yPercent:0, rotateX:0, rotateZ:0, scale:1, duration:0.42, ease:'back.out(1.4)' }, i===0 ? '-=0.15' : '-=0.10')
          .to(sel, { scale:1.01, duration:0.10 })
          .to(sel, { scale:1.00, duration:0.12 }, '-=0.05');
      });

      tl.fromTo('#stage',
        { filter:'drop-shadow(0 20px 60px rgba(0,0,0,.45))' },
        { filter:'drop-shadow(0 40px 120px rgba(0,0,0,.55))', duration:0.45 }, '-=0.2'
      );

      // Видео запускаем в конце, но само «видео-слой» виден всегда с poster и вашей непрозрачностью
      tl.add('videoIn');
      tl.call(() => {
        try { video.currentTime = 0; } catch(e) {}
        const p = video.play?.(); if (p && p.catch) p.catch(()=>{});
      }, null, 'videoIn');

      return tl;
    }

    /* ========= UI-панель (всегда активна) ========= */
    const $ = (id) => document.getElementById(id);
    const fit = $('fit'), objx = $('objx'), objy = $('objy'), objxNum = $('objxNum'), objyNum = $('objyNum');
    const x = $('x'), y = $('y'), sx = $('sx'), sy = $('sy'), rot = $('rot'), op = $('op');
    const xNum = $('xNum'), yNum = $('yNum'), sxNum = $('sxNum'), syNum = $('syNum'), rotNum = $('rotNum'), opNum = $('opNum');
    const progress = $('progress'), progVal = $('progVal');
    const copyCss = $('copyCss'), resetBtn = $('reset');

    const STORAGE_KEY = 'veoSlidersV2';

    const state = {
      fit: getVar('--veo-object-fit', 'fill'),
      objx: pctToNum(getVar('--veo-objx', '50%')),
      objy: pctToNum(getVar('--veo-objy', '50%')),
      x: pxToNum(getVar('--veo-shift-x', '0px')),
      y: pxToNum(getVar('--veo-shift-y', '0px')),
      sx: +getVar('--veo-scale-x', '1'),
      sy: +getVar('--veo-scale-y', '1'),
      rot: degToNum(getVar('--veo-rot', '0deg')),
      op: +getVar('--veo-user-op', '.35'),
      progress: 0
    };

    function getVar(name, fallback){ const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim(); return v || fallback; }
    function pxToNum(v){ return parseFloat(String(v).replace('px',''))||0; }
    function degToNum(v){ return parseFloat(String(v).replace('deg',''))||0; }
    function pctToNum(v){ return parseFloat(String(v).replace('%',''))||0; }

    function applyVars(){
      const r = document.documentElement.style;
      r.setProperty('--veo-object-fit', state.fit);
      r.setProperty('--veo-objx', `${state.objx}%`);
      r.setProperty('--veo-objy', `${state.objy}%`);
      r.setProperty('--veo-shift-x', `${state.x}px`);
      r.setProperty('--veo-shift-y', `${state.y}px`);
      r.setProperty('--veo-scale-x', String(state.sx));
      r.setProperty('--veo-scale-y', String(state.sy));
      r.setProperty('--veo-rot', `${state.rot}deg`);
      r.setProperty('--veo-user-op', String(state.op));
    }

    function syncUI(){
      fit.value = state.fit;
      objx.value = objxNum.value = state.objx;
      objy.value = objyNum.value = state.objy;
      x.value = xNum.value = state.x;
      y.value = yNum.value = state.y;
      sx.value = sxNum.value = state.sx;
      sy.value = syNum.value = state.sy;
      rot.value = rotNum.value = state.rot;
      op.value = opNum.value = state.op;
      progress.value = Math.round(state.progress * 1000);
      progVal.textContent = Math.round(state.progress * 100);
    }

    function loadSaved(){
      try{
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (saved && typeof saved === 'object') Object.assign(state, saved);
      }catch{}
      applyVars(); syncUI();
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function linkRangeNumber(range, number, key, toFixed=null){
      const fmt = (v)=> (toFixed!=null ? (+v).toFixed(toFixed) : v);
      range.addEventListener('input', () => { state[key] = +range.value; number.value = fmt(range.value); applyVars(); saveState(); });
      number.addEventListener('input', () => { state[key] = +number.value; range.value = fmt(number.value); applyVars(); saveState(); });
    }

    function bindUI(){
      fit.addEventListener('change', () => { state.fit = fit.value; applyVars(); saveState(); });

      linkRangeNumber(objx, objxNum, 'objx', 1);
      linkRangeNumber(objy, objyNum, 'objy', 1);

      linkRangeNumber(x, xNum, 'x', 1);
      linkRangeNumber(y, yNum, 'y', 1);

      linkRangeNumber(sx, sxNum, 'sx', 3);
      linkRangeNumber(sy, syNum, 'sy', 3);

      linkRangeNumber(rot, rotNum, 'rot', 2);
      linkRangeNumber(op, opNum, 'op', 2);

      progress.addEventListener('input', () => {
        const p = (+progress.value)/1000;
        state.progress = p;
        progVal.textContent = Math.round(p*100);
        if (tl){
          tl.pause();
          tl.progress(p);
        }
        playPauseBtn.textContent = 'Пуск';
      });

      copyCss.addEventListener('click', async () => {
        const css = `:root{
  --veo-shift-x: ${state.x}px;
  --veo-shift-y: ${state.y}px;
  --veo-scale-x: ${state.sx};
  --veo-scale-y: ${state.sy};
  --veo-rot: ${state.rot}deg;
  --veo-object-fit: ${state.fit};
  --veo-objx: ${state.objx}%;
  --veo-objy: ${state.objy}%;
  --veo-user-op: ${state.op};
}`;
        try{ await navigator.clipboard.writeText(css); copyCss.textContent='Скопировано!'; setTimeout(()=>copyCss.textContent='Скопировать CSS',1200); }
        catch{ prompt('Скопируйте CSS:', css); }
      });

      resetBtn.addEventListener('click', () => {
        Object.assign(state, { fit:'fill', objx:50, objy:50, x:0, y:0, sx:1, sy:1, rot:0, op:.35, progress:0 });
        applyVars(); syncUI(); saveState();
        if (tl){ tl.pause(0); }
        playPauseBtn.textContent = 'Пуск';
      });
    }

    /* ========= Кнопки воспроизведения ========= */
    function bindPlayback(){
      playPauseBtn.addEventListener('click', () => {
        if (!tl) return;
        if (tl.isActive()){
          tl.pause();
          playPauseBtn.textContent = 'Пуск';
        } else {
          tl.play();
          playPauseBtn.textContent = 'Пауза';
        }
      });

      replayBtn.addEventListener('click', () => {
        if (!tl) return;
        try { video.pause(); video.currentTime = 0; } catch(e){}
        tl.pause(0).play(0);
        playPauseBtn.textContent = 'Пауза';
      });

      // Синхронизация скраббера во время проигрывания
      gsap.ticker.add(() => {
        if (!tl) return;
        if (tl.isActive()){
          const p = tl.progress();
          state.progress = p;
          progress.value = Math.round(p*1000);
          progVal.textContent = Math.round(p*100);
        }
      });
    }

    /* ========= Инициализация ========= */
    async function init(){
      if (prefersReduced){
        gsap.set(layers, { opacity:0, clearProps:'transform,filter' });
        gsap.set('.device, .s6', { opacity:1 });
        // Видео оставляем видимым с poster и вашей opacity — можно настраивать и без анимации
      }

      loadSaved();
      bindUI();

      await preloadImages(layers.filter(l => l.tagName === 'IMG').map(l => l.currentSrc || l.src));
      await preloadVideo(video);

      buildTimeline();
      bindPlayback();

      // Автостарт при появлении в зоне видимости — при желании можно удалить
      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          if (e.isIntersecting && tl && !tl.isActive() && tl.progress()===0){
            tl.play(0);
            playPauseBtn.textContent = 'Пауза';
          }
        });
      }, { threshold:0.4 });
      io.observe(document.getElementById('hero'));
    }

    init();
  })();
  </script>
</body>
</html>
