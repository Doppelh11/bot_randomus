<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Сборка карточки → финальное видео (без 7-го слайда)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{ --fg:#fff; --muted:#b5b6bf; --maxw:1200px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:radial-gradient(1200px 900px at 20% 20%, #171924 0, #0f1118 50%, #0c0d10 100%);
    }
    .wrap{max-width:var(--maxw); margin:auto; padding:clamp(20px,4vw,64px)}
    .hero{
      display:grid; grid-template-columns:1.1fr 0.9fr; align-items:center;
      gap:clamp(20px,5vw,80px); min-height:90svh;
    }
    @media (max-width:960px){
      .hero{grid-template-columns:1fr; min-height:auto}
      .copy{text-align:center; order:-1}
    }
    .copy h1{margin:0 0 .4em; line-height:1.05; font-weight:800; font-size:clamp(28px,6vw,62px); letter-spacing:-.02em}
    .copy p{margin:0 0 1.25rem; color:var(--muted); font-size:clamp(16px,2.3vw,20px)}
    .btn{
      appearance:none; border:none; background:#ffffff10; color:#fff;
      padding:12px 18px; border-radius:16px; font-weight:600; cursor:pointer;
      backdrop-filter:blur(6px); transition:transform .15s ease, background .2s ease;
    }
    .btn:hover{transform:translateY(-1px); background:#ffffff18}

    /* ===== Сцена ===== */
    .stage{
      position:relative; width:100%; max-width:760px;
      aspect-ratio: 2048 / 1828;
      margin-inline:auto; isolation:isolate;
      filter:drop-shadow(0 40px 120px rgba(0,0,0,.55));
      perspective:1200px; contain:layout paint;
      cursor:default;
    }
    .layer{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:contain; transform-style:preserve-3d; backface-visibility:hidden;
      will-change:transform,opacity,filter; opacity:0;
    }
    .veo{
      pointer-events:none; width:100%; height:100%;
      object-fit:cover; object-position:50% 50%;
      opacity:0; will-change:opacity;
    }

    /* ===== Левая колонка: CTR (сверху) + сцена ===== */
    .visual{
      display:flex; flex-direction:column; align-items:center;
      max-width:760px; width:100%; margin-inline:auto;
    }

    /* ===== CTR — только текст, центр, без фонов/рамок ===== */
    .ctr{
      width:100%; margin-bottom:12px;
      display:flex; justify-content:center;
    }
    .ctr-row{
      display:flex; align-items:baseline; gap:10px;
    }
    .ctr-label{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-weight:800; letter-spacing:.12em; text-transform:uppercase;
      font-size: clamp(18px, 2.8vw, 28px);
      line-height:1;
    }

    .slots{
      display:flex; align-items:baseline; gap:1px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-weight:800; letter-spacing:-0.01em;
      font-variant-numeric: tabular-nums;
      font-size: clamp(28px, 4.6vw, 56px);
      line-height:1;
      color:var(--fg);
    }

    .col{ height:auto; overflow:hidden; position:relative; }
    .col-ones{  width:0.85ch; }    /* шире для «4» */
    .col-tenth{ width:0.70ch; }    /* ближе к точке */
    .dot{ margin:0 1px 0 2px; opacity:.95 }
    .pct{ opacity:.95; font-size:.85em; margin-left:2px }

    .reel{
      position:absolute; left:0; top:0;
      will-change:transform; display:flex; flex-direction:column;
      background:transparent !important;
    }
    .reel span{
      display:block; height:1em; line-height:1; text-align:center;
      background:transparent; -webkit-text-fill-color: currentColor;
    }

    /* Финальный тёплый градиент + shine на 4.5% */
    .slots.celebrate .reel span{
      background: linear-gradient(90deg, #FF7A00 0%, #FFC247 28%, #FFF2D6 52%, #FFB088 78%, #FF7A00 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: warmShine 1.1s ease-out 1;
    }
    @keyframes warmShine{
      0%   { background-position:   0% 50%; }
      100% { background-position: 120% 50%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero" id="hero">
      <!-- Левая колонка: CTR сверху, сцена снизу -->
      <div class="visual">
        <div class="ctr">
          <div class="ctr-row">
            <div class="ctr-label">CTR</div>
            <div class="slots" id="slots" aria-label="CTR">
              <div class="col col-ones"><div class="reel" id="ones"></div></div>
              <span class="dot">.</span>
              <div class="col col-tenth"><div class="reel" id="tenths"></div></div>
              <span class="pct">%</span>
            </div>
          </div>
        </div>

        <!-- Сцена -->
        <div class="stage" id="stage" aria-hidden="true">
          <img class="layer device" src="assets/step1.png" alt="tablet frame">
          <img class="layer s1" src="assets/step2.png" alt="">
          <img class="layer s2" src="assets/step3.png" alt="">
          <img class="layer s3" src="assets/step4.png" alt="">
          <img class="layer s4" src="assets/step5.png" alt="">
          <img class="layer s5" src="assets/step6.png" alt="">
          <video class="layer veo" id="veo" muted playsinline preload="auto" poster="assets/step6.png">
            <source src="assets/veo.webm#t=0.001" type="video/webm">
            <source src="assets/veo.mp4#t=0.001"  type="video/mp4">
          </video>
        </div>
      </div>

      <!-- Правая колонка -->
      <div class="copy">
        <h1>Сборка карточки → финальное видео</h1>
        <p>CTR растёт до 3.6% по шагам. Финальные 4.5% появляются в середине видео с тёплым shine.</p>
        <button class="btn" id="replay">Повторить</button>
        <div class="hint">Файлы: <code>assets/step1.png…step6.png</code>, <code>veo.webm</code> (+опц. <code>veo.mp4</code>).</div>
      </div>
    </section>
  </div>

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>
  <script>
  (() => {
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const replayBtn = document.getElementById('replay');
    const heroEl  = document.getElementById('hero');
    const stageEl = document.getElementById('stage');
    const layers  = [...document.querySelectorAll('.layer')];
    const video   = document.getElementById('veo');

    /* ===== CTR: слот-машина ===== */
    const onesReel   = document.getElementById('ones');
    const tenthsReel = document.getElementById('tenths');
    const slotsBox   = document.getElementById('slots');

    const DIGITS_LOOP = 8;
    const ctrPoints   = [1.9, 2.3, 2.6, 3.3, 3.6, 4.5];
    const onesSeq     = ctrPoints.map(v => Math.floor(v));
    const tenthsSeq   = ctrPoints.map(v => Math.round((v%1)*10));
    let lineH = 0;

    function buildReel(el){
      const frag = document.createDocumentFragment();
      for (let k=0;k<DIGITS_LOOP;k++){
        for (let d=0; d<=9; d++){
          const s=document.createElement('span'); s.textContent=d; frag.appendChild(s);
        }
      }
      el.innerHTML=''; el.appendChild(frag);
    }
    function measureAndFit(){
      const probe = onesReel.querySelector('span') || tenthsReel.querySelector('span');
      lineH = probe ? probe.getBoundingClientRect().height : 0;
      const slotH = Math.round(lineH * 1.28);
      document.querySelectorAll('.col').forEach(c => { c.style.height = slotH + 'px'; });
      const topPad = Math.round((slotH - lineH)/2);
      document.querySelectorAll('.reel').forEach(r => { r.style.top = topPad + 'px'; });
    }
    function setIndex(el, index, immediate=false){
      const y = -index * lineH;
      if (immediate) gsap.set(el, { y }); else gsap.to(el, { y, duration:0.5, ease:'power2.out' });
    }
    function spinTo(el, toIndex, dur=0.5, ease='power3.out'){
      const over = 0.18 * lineH;
      const y1 = -toIndex * lineH - over;
      const y2 = -toIndex * lineH;
      const tl = gsap.timeline();
      tl.to(el, { y:y1, duration:dur*0.75, ease })
        .to(el, { y:y2, duration:dur*0.25, ease:'power2.out' });
      return tl;
    }

    /* ---------- ассеты ---------- */
    const preloadImages = (srcs) => Promise.all(srcs.map(s => new Promise(res => {
      const im=new Image(); im.onload=im.onerror=()=>res(); im.src=s;
    })));
    const preloadVideo = (v) => new Promise(res => {
      if (!v) return res();
      const ready = () => { v.removeEventListener('canplaythrough', ready); v.removeEventListener('loadeddata', ready); res(); };
      if (v.readyState >= 3) return res();
      v.addEventListener('canplaythrough', ready, { once:true });
      v.addEventListener('loadeddata', ready, { once:true });
      try { v.load(); } catch(e) {}
    });

    /* ---------- таймлайн сцены + CTR до 3.6% ---------- */
    function buildTimeline(){
      const tl = gsap.timeline({ defaults:{ ease:'power3.out' } });

      // Стартовые
      gsap.set('.device', { opacity:0, yPercent:4, scale:0.985, rotateZ:-1, filter:'blur(6px)' });
      gsap.set(['.s1','.s2','.s3','.s4','.s5'], { opacity:0, yPercent:3, rotateX:4, rotateZ:-1, scale:0.99 });
      gsap.set('.veo', { opacity:0 });

      // 0) планшет
      tl.to('.device', { opacity:1, yPercent:0, scale:1, rotateZ:0, filter:'blur(0px)', duration:0.55, ease:'back.out(1.6)' });

      // Порядок слоёв: s1 (step2) → s3 (step4) → s2 (step3) → s4 → s5
      const sels = ['.s1','.s3','.s2','.s4','.s5'];
      sels.forEach((sel, i) => {
        tl.to(sel, { opacity:1, yPercent:0, rotateX:0, rotateZ:0, scale:1, duration:0.42, ease:'back.out(1.4)' }, i===0 ? '-=0.15' : '-=0.10')
          .to(sel, { scale:1.01, duration:0.10 })
          .to(sel, { scale:1.00, dur
