<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Сборка карточки → финальное видео (без 7-го слайда)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{ --fg:#fff; --muted:#b5b6bf; --maxw:1200px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:radial-gradient(1200px 900px at 20% 20%, #171924 0, #0f1118 50%, #0c0d10 100%);
    }
    .wrap{max-width:var(--maxw); margin:auto; padding:clamp(20px,4vw,64px)}
    .hero{
      display:grid; grid-template-columns:1.1fr 0.9fr; align-items:center;
      gap:clamp(20px,5vw,80px); min-height:90svh;
    }
    @media (max-width:960px){
      .hero{grid-template-columns:1fr; min-height:auto}
      .copy{text-align:center; order:-1}
    }
    .copy h1{margin:0 0 .4em; line-height:1.05; font-weight:800; font-size:clamp(28px,6vw,62px); letter-spacing:-.02em}
    .copy p{margin:0 0 1.25rem; color:var(--muted); font-size:clamp(16px,2.3vw,20px)}
    .btn{
      appearance:none; border:none; background:#ffffff10; color:#fff;
      padding:12px 18px; border-radius:16px; font-weight:600; cursor:pointer;
      backdrop-filter:blur(6px); transition:transform .15s ease, background .2s ease;
    }
    .btn:hover{transform:translateY(-1px); background:#ffffff18}

    /* ===== Сцена ===== */
    .stage{
      position:relative; width:100%; max-width:760px;
      /* точное соотношение PNG (2048×1828) */
      aspect-ratio: 2048 / 1828;
      margin-inline:auto; isolation:isolate;
      filter:drop-shadow(0 40px 120px rgba(0,0,0,.55));
      perspective:1200px; contain:layout paint;
      cursor:default;
    }
    .layer{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:contain; transform-style:preserve-3d; backface-visibility:hidden;
      will-change:transform,opacity,filter; opacity:0;
    }

    /* Финальное видео: без искажений (cover), по центру */
    .veo{
      pointer-events:none; width:100%; height:100%;
      object-fit:cover; object-position:50% 50%;
      opacity:0; will-change:opacity;
    }

    /* ===== Левая колонка: CTR (сверху) + сцена ===== */
    .visual{
      display:flex; flex-direction:column; align-items:center;
      max-width:760px; width:100%; margin-inline:auto;
    }

    /* ===== CTR (только текст) — выровнен по центру ===== */
    .ctr{
      width:100%; margin-bottom:12px;
      display:flex; justify-content:center; align-items:flex-end; gap:10px;
      /* никаких фонов/рамок/теней — только текст */
    }
    .ctr-label{
      font:700 12px/1 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      letter-spacing:.14em; text-transform:uppercase; opacity:.95;
    }
    .slots{
      display:flex; align-items:baseline; gap:2px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-weight:800; letter-spacing:-0.015em;
      font-variant-numeric: tabular-nums;
      font-size: clamp(28px, 4.6vw, 56px);
      line-height:1;
      transform-origin:center center;
      color:var(--fg);
    }
    .col{
      height:auto; width:0.75ch; overflow:hidden; position:relative;
      /* без подложек */
    }
    .reel{ position:absolute; left:0; top:0; will-change:transform; display:flex; flex-direction:column; }
    .reel span{ display:block; height:1em; line-height:1; text-align:center; }
    .dot{ opacity:.95; margin:0 2px }
    .pct{ opacity:.95; font-size:.85em; margin-left:2px }

    /* Финальный градиент+shine (тёплый оранжевый) — включается на 4.5% */
    .slots.celebrate{ filter: drop-shadow(0 0 24px rgba(255,168,64,.35)); }
    .slots.celebrate .reel span{
      background: linear-gradient(90deg, #FF8A00 0%, #FFC247 28%, #FFF2D6 52%, #FF9D5C 78%, #FF8A00 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: warmShine 1.1s ease-out 1;
    }
    @keyframes warmShine{
      0%   { background-position:   0% 50%; }
      100% { background-position: 120% 50%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero" id="hero">
      <!-- Левая колонка: CTR сверху, сцена снизу -->
      <div class="visual">
        <div class="ctr">
          <div class="ctr-label">CTR</div>
          <div class="slots" id="slots" aria-label="CTR">
            <div class="col"><div class="reel" id="ones"></div></div>
            <span class="dot">.</span>
            <div class="col"><div class="reel" id="tenths"></div></div>
            <span class="pct">%</span>
          </div>
        </div>

        <div class="stage" id="stage" aria-hidden="true">
          <!-- База: планшет -->
          <img class="layer device" src="assets/step1.png" alt="tablet frame">

          <!-- 5 экранных слоёв (step2…step6) -->
          <img class="layer s1" src="assets/step2.png" alt="">
          <img class="layer s2" src="assets/step3.png" alt="">
          <img class="layer s3" src="assets/step4.png" alt="">
          <img class="layer s4" src="assets/step5.png" alt="">
          <img class="layer s5" src="assets/step6.png" alt="">

          <!-- Финальное видео поверх всех слоёв -->
          <video class="layer veo" id="veo" muted playsinline preload="auto" poster="assets/step6.png">
            <source src="assets/veo.webm#t=0.001" type="video/webm">
            <source src="assets/veo.mp4#t=0.001"  type="video/mp4">
          </video>
        </div>
      </div>

      <!-- Правая колонка — как было -->
      <div class="copy">
        <h1>Сборка карточки → финальное видео</h1>
        <p>Число CTR растёт до 3.6% по шагам. Финальные 4.5% появляются в середине видео с тёплым shine и пульсом.</p>
        <button class="btn" id="replay">Повторить</button>
        <div class="hint">Файлы: <code>assets/step1.png…step6.png</code>, <code>veo.webm</code> (+опц. <code>veo.mp4</code>).</div>
      </div>
    </section>
  </div>

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>
  <script>
  (() => {
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const replayBtn = document.getElementById('replay');
    const heroEl  = document.getElementById('hero');
    const stageEl = document.getElementById('stage');
    const layers  = [...document.querySelectorAll('.layer')];
    const video   = document.getElementById('veo');

    /* ===== CTR: слот-машина ===== */
    const onesReel   = document.getElementById('ones');
    const tenthsReel = document.getElementById('tenths');
    const slotsBox   = document.getElementById('slots');

    const DIGITS_LOOP = 8;                      // запас проходов
    const ctrPoints   = [1.9, 2.3, 2.6, 3.3, 3.6, 4.5]; // start + 5 шагов
    const onesSeq     = ctrPoints.map(v => Math.floor(v));            // [1,2,2,3,3,4]
    const tenthsSeq   = ctrPoints.map(v => Math.round((v%1)*10));     // [9,3,6,3,6,5]
    let lineH = 0; // фактическая высота строки в px (меряем), окно делаем чуть выше

    function buildReel(el){
      const frag = document.createDocumentFragment();
      for (let k=0;k<DIGITS_LOOP;k++){
        for (let d=0; d<=9; d++){
          const s=document.createElement('span'); s.textContent=d; frag.appendChild(s);
        }
      }
      el.innerHTML=''; el.appendChild(frag);
    }
    function measureAndFit(){
      // меряем реальную высоту цифры и добавляем запас, чтобы ничего не обрезалось
      const any = onesReel.querySelector('span') || tenthsReel.querySelector('span');
      const h = any ? any.getBoundingClientRect().height : 0;
      lineH = h; // используем как шаг прокрутки
      const slotH = Math.round(h * 1.18); // окно ≈ 118% от строки
      document.querySelectorAll('.col').forEach(c => { c.style.height = slotH + 'px'; });
      // центрируем цифру в окне
      document.querySelectorAll('.reel').forEach(r => { r.style.top = Math.round((slotH - h)/2) + 'px'; });
    }
    function setIndex(el, index, immediate=false){
      const y = -index * lineH;
      if (immediate) gsap.set(el, { y }); else gsap.to(el, { y, duration:0.5, ease:'power2.out' });
    }
    function spinTo(el, toIndex, dur=0.5, ease='power3.out'){
      const over = 0.18 * lineH;
      const y1 = -toIndex * lineH - over;
      const y2 = -toIndex * lineH;
      const tl = gsap.timeline();
      tl.to(el, { y:y1, duration:dur*0.75, ease })
        .to(el, { y:y2, duration:dur*0.25, ease:'power2.out' });
      return tl;
    }

    /* ---------- ассеты ---------- */
    const preloadImages = (srcs) => Promise.all(srcs.map(s => new Promise(res => {
      const im=new Image(); im.onload=im.onerror=()=>res(); im.src=s;
    })));
    const preloadVideo = (v) => new Promise(res => {
      if (!v) return res();
      const ready = () => { v.removeEventListener('canplaythrough', ready); v.removeEventListener('loadeddata', ready); res(); };
      if (v.readyState >= 3) return res();
      v.addEventListener('canplaythrough', ready, { once:true });
      v.addEventListener('loadeddata', ready, { once:true });
      try { v.load(); } catch(e) {}
    });

    /* ---------- таймлайн сцены + привязка CTR (до 3.6%) ---------- */
    function buildTimeline(){
      const tl = gsap.timeline({ defaults:{ ease:'power3.out' } });

      // Стартовые состояния
      gsap.set('.device', { opacity:0, yPercent:4, scale:0.985, rotateZ:-1, filter:'blur(6px)' });
      gsap.set(['.s1','.s2','.s3','.s4','.s5'], { opacity:0, yPercent:3, rotateX:4, rotateZ:-1, scale:0.99 });
      gsap.set('.veo', { opacity:0 });

      // 0) планшет
      tl.to('.device', { opacity:1, yPercent:0, scale:1, rotateZ:0, filter:'blur(0px)', duration:0.55, ease:'back.out(1.6)' });

      // 1–5) слои; CTR крутится до 3.6% (последнее изменение на s4)
      const sels = ['.s1','.s2','.s3','.s4','.s5'];
      sels.forEach((sel, i) => {
        tl.to(sel, { opacity:1, yPercent:0, rotateX:0, rotateZ:0, scale:1, duration:0.42, ease:'back.out(1.4)' }, i===0 ? '-=0.15' : '-=0.10')
          .to(sel, { scale:1.01, duration:0.10 })
          .to(sel, { scale:1.00, duration:0.12 }, '-=0.05');

        if (i < ctrPoints.length - 2) { // шаги 1..4
          const stepIdx = i+1;
          const onesIdx   = stepIdx*10 + onesSeq[stepIdx];
          const tenthsIdx = stepIdx*10 + tenthsSeq[stepIdx];
          const label = `ctr_${stepIdx}`;
          tl.add(label, '>-0.02');
          tl.add(spinTo(onesReel,   onesIdx,   0.5, 'power3.out'), label);
          tl.add(spinTo(tenthsReel, tenthsIdx, 0.5, 'power3.out'), `${label}+=0.06`);
        }
      });

      // Подсвет сцены
      tl.fromTo('#stage',
        { filter:'drop-shadow(0 20px 60px rgba(0,0,0,.45))' },
        { filter:'drop-shadow(0 40px 120px rgba(0,0,0,.55))', duration:0.45 }, '-=0.2'
      );

      // Переключение на видео
      tl.add('switchToVideo');
      tl.call(() => {
        try { video.currentTime = 0; } catch(e) {}
        const p = video.play?.(); if (p && p.catch) p.catch(()=>{});
      }, null, 'switchToVideo');
      tl.to('.veo', { opacity:1, duration:0.5 }, 'switchToVideo');
      tl.to(['.device','.s1','.s2','.s3','.s4','.s5'], { opacity:0, duration:0.5 }, 'switchToVideo');

      return tl;
    }

    /* ---------- финальная 4.5% в середине видео + тёплый shine ---------- */
    function scheduleFinalDuringVideo(){
      let fired=false;
      const doFinal=()=> {
        if (fired) return; fired=true;
        const finalOnesIdx   = 5*10 + Math.floor(ctrPoints[5]);          // 4
        const finalTenthsIdx = 5*10 + Math.round((ctrPoints[5]%1)*10);   // 5
        const tl = gsap.timeline();
        tl.add(spinTo(onesReel,   finalOnesIdx,   0.55, 'power3.out'))
          .add(spinTo(tenthsReel, finalTenthsIdx, 0.55, 'power3.out'), '+=0.08')
          .fromTo('#slots', { scale:1 }, { scale:1.08, duration:0.12, ease:'power3.out' }, '-=0.10')
          .to('#slots', { scale:1.00, duration:0.18, ease:'power3.out' }, '>');
        // тёплый градиент + shine
        slotsBox.classList.add('celebrate');
        setTimeout(()=> slotsBox.classList.remove('celebrate'), 1300);
      };

      if (!isFinite(video.duration) || video.duration === 0) {
        // фолбэк, если метаданные недоступны
        setTimeout(doFinal, 700);
        return;
      }
      const mid = video.duration * 0.5;
      const onTime = () => {
        if (video.currentTime >= mid) {
          video.removeEventListener('timeupdate', onTime);
          doFinal();
        }
      };
      video.addEventListener('timeupdate', onTime);
    }

    /* ---------- init ---------- */
    async function init(){
      // собрать барабаны и подогнать окно
      buildReel(onesReel); buildReel(tenthsReel);
      requestAnimationFrame(()=>{
        measureAndFit();
        // старт 1.9 мгновенно
        const startOnesIdx   = 0*10 + Math.floor(ctrPoints[0]);        // 1
        const startTenthsIdx = 0*10 + Math.round((ctrPoints[0]%1)*10); // 9
        setIndex(onesReel,   startOnesIdx,   true);
        setIndex(tenthsReel, startTenthsIdx, true);
      });

      if (prefersReduced){
        // Без анимации: показать сразу 4.5%
        gsap.set(layers, { opacity:0, clearProps:'transform,filter' });
        gsap.set('.veo', { opacity:1 });
        requestAnimationFrame(()=>{
          const finalOnesIdx   = 5*10 + Math.floor(ctrPoints[5]);
          const finalTenthsIdx = 5*10 + Math.round((ctrPoints[5]%1)*10);
          setIndex(onesReel, finalOnesIdx, true);
          setIndex(tenthsReel, finalTenthsIdx, true);
        });
        return;
      }

      // предзагрузка ассетов
      await preloadImages(['assets/step1.png','assets/step2.png','assets/step3.png','assets/step4.png','assets/step5.png','assets/step6.png']);
      await preloadVideo(video);

      const tl = buildTimeline();

      // запуск финала в середине видео
      if (video.readyState >= 1) scheduleFinalDuringVideo();
      else video.addEventListener('loadedmetadata', scheduleFinalDuringVideo, { once:true });

      // Повтор (оставил как было у тебя)
      const restart = () => {
        try { video.pause(); video.currentTime = 0; } catch(e){}
        // сброс на 1.9
        const startOnesIdx   = 0*10 + Math.floor(ctrPoints[0]);
        const startTenthsIdx = 0*10 + Math.round((ctrPoints[0]%1)*10);
        gsap.set(onesReel,   { y: -startOnesIdx   * lineH });
        gsap.set(tenthsReel, { y: -startTenthsIdx * lineH });
        slotsBox.classList.remove('celebrate');
        tl.restart();
        if (video.readyState >= 1) scheduleFinalDuringVideo();
        else video.addEventListener('loadedmetadata', scheduleFinalDuringVideo, { once:true });
      };
      document.getElementById('replay').addEventListener('click', restart);

      // Hover-replay видео: только когда ролик ДОИГРАЛ
      let ended=false;
      video.addEventListener('ended', ()=>{ ended=true; });
      stageEl.addEventListener('mouseenter', ()=>{
        if (!ended) return;
        try { video.currentTime = 0; } catch(e){}
        const p=video.play?.(); if (p && p.catch) p.catch(()=>{});
        ended=false;
        if (video.readyState >= 1) scheduleFinalDuringVideo();
        else video.addEventListener('loadedmetadata', scheduleFinalDuringVideo, { once:true });
      });

      // Автостарт при входе в вьюпорт
      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => e.isIntersecting && restart());
      }, { threshold:0.4 });
      io.observe(heroEl);

      // Респонсив: пересчёт окна и текущей позиции при ресайзе
      let rid;
      window.addEventListener('resize', () => {
        cancelAnimationFrame(rid);
        rid = requestAnimationFrame(() => {
          const prevH = lineH;
          measureAndFit();
          if (!prevH || prevH === lineH) return;
          const curY1 = gsap.getProperty(onesReel, 'y');
          const curY2 = gsap.getProperty(tenthsReel, 'y');
          const idx1 = Math.round(-curY1 / prevH);
          const idx2 = Math.round(-curY2 / prevH);
          gsap.set(onesReel,   { y: -idx1 * lineH });
          gsap.set(tenthsReel, { y: -idx2 * lineH });
        });
      });
    }

    init();
  })();
  </script>
</body>
</html>
