<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hero-анимация — 7 слоёв + видео (одна гибкая настройка)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0c0d10; --fg:#fff; --muted:#b5b6bf; --maxw:1200px;

      /* ===== Единственная настройка: соберите любую трансформацию тут =====
         Примеры:
         translate(2px,-1px) scale(1.004) rotate(0.05deg)
         translate(0px,0px)  scale(1.003, 0.998)
      */
      --veo: translate(0px,0px) scale(1) rotate(0deg);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:radial-gradient(1200px 900px at 20% 20%, #171924 0, #0f1118 50%, #0c0d10 100%);
    }
    .wrap{max-width:var(--maxw); margin:auto; padding:clamp(20px,4vw,64px)}
    .hero{
      display:grid; grid-template-columns:1.1fr 0.9fr; align-items:center;
      gap:clamp(20px,5vw,80px); min-height:90svh;
    }
    @media (max-width:960px){
      .hero{grid-template-columns:1fr; min-height:auto}
      .copy{text-align:center; order:-1}
    }
    .copy h1{margin:0 0 .4em; line-height:1.05; font-weight:800; font-size:clamp(28px,6vw,62px); letter-spacing:-.02em}
    .copy p{margin:0 0 1.25rem; color:var(--muted); font-size:clamp(16px,2.3vw,20px)}
    .btn{
      appearance:none; border:none; background:#ffffff10; color:#fff;
      padding:12px 18px; border-radius:16px; font-weight:600; cursor:pointer;
      backdrop-filter:blur(6px); transition:transform .15s ease, background .2s ease;
    }
    .btn:hover{transform:translateY(-1px); background:#ffffff18}
    .btn:active{transform:translateY(0)}

    /* ===== Сцена ===== */
    .stage{
      position:relative; width:100%; max-width:760px;
      aspect-ratio: 2048 / 1828; /* точное соотношение исходников */
      margin-inline:auto; isolation:isolate;
      filter:drop-shadow(0 40px 120px rgba(0,0,0,.55));
      perspective:1200px; contain:layout paint;
    }
    .layer{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:contain; transform-style:preserve-3d; backface-visibility:hidden;
      will-change:transform,opacity,filter; opacity:0;
    }

    /* ===== Видео: заполняем рамку PNG + применяем единственную переменную ===== */
    .veo{
      pointer-events:none;
      width:100%;
      height:100%;
      object-fit: fill;            /* чтобы заняло рамку один-в-один */
      transform-origin: top left;  /* удобная точка для подгонки */
      will-change:opacity, transform;
      transform: var(--veo);       /* ВСЯ подгонка — одной переменной */
    }

    .hint{ text-align:center; color:#a7aab8; margin-top:22px; font-size:13px; opacity:.75 }

    /* ===== Одна компактная настройка на странице (без режимов) ===== */
    .one-var{
      position:fixed; right:16px; bottom:16px; width:min(520px, 94vw);
      background:#0e1016cc; color:#fff; border:1px solid #ffffff22; border-radius:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.5); backdrop-filter:blur(10px);
      padding:10px; z-index:9999;
      display:flex; gap:8px; align-items:center;
    }
    .one-var label{ font:12px/1 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#b9bfd4 }
    .one-var input{
      flex:1; min-width:0; padding:10px 12px; border-radius:10px;
      background:#151826; color:#fff; border:1px solid #ffffff28;
      font:12px/1.3 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .one-var button{
      padding:10px 12px; border-radius:10px; border:1px solid #ffffff22;
      background:#ffffff12; color:#fff; cursor:pointer; white-space:nowrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero" id="hero">
      <div class="stage" id="stage" aria-hidden="true">
        <!-- 1) планшет -->
        <img class="layer device" src="assets/step1.png" alt="tablet frame">

        <!-- 2) 6 экранных слоёв -->
        <img class="layer s1" src="assets/step2.png" alt="">
        <img class="layer s2" src="assets/step3.png" alt="">
        <img class="layer s3" src="assets/step4.png" alt="">
        <img class="layer s4" src="assets/step5.png" alt="">
        <img class="layer s5" src="assets/step6.png" alt="">
        <img class="layer s6" src="assets/step7.png" alt="">

        <!-- 3) Финальное видео поверх -->
        <video class="layer veo" id="veo" muted playsinline preload="auto" poster="assets/step7.png">
          <source src="assets/veo.webm#t=0.001" type="video/webm">
          <source src="assets/veo.mp4#t=0.001"  type="video/mp4">
        </video>
      </div>

      <div class="copy">
        <h1>Анимация «сборки» — 7 слайдов + видео</h1>
        <p>Вся подгонка видео — одной переменной <code>--veo</code>.</p>
        <button class="btn" id="replay">Повторить</button>
        <div class="hint">Формируйте значение, например: <code>translate(2px,-1px) scale(1.003) rotate(0.04deg)</code>.</div>
      </div>
    </section>
  </div>

  <!-- Единственный контрол: правый нижний угол -->
  <div class="one-var" role="group" aria-label="Единственная настройка видео">
    <label for="veoInput">--veo:</label>
    <input id="veoInput" spellcheck="false" autocomplete="off" />
    <button id="copyVar">Скопировать CSS</button>
    <button id="resetVar" title="Сброс к значению по умолчанию">Сброс</button>
  </div>

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>
  <script>
  (() => {
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    const replayBtn = document.getElementById('replay');
    const layers    = [...document.querySelectorAll('.layer')];
    const video     = document.getElementById('veo');

    /* ========= Единственная настройка (переменная --veo) ========= */
    const STORAGE_KEY = 'veoSingleVar';
    const input = document.getElementById('veoInput');
    const copyBtn = document.getElementById('copyVar');
    const resetBtn = document.getElementById('resetVar');
    const defaultVeo = getComputedStyle(document.documentElement).getPropertyValue('--veo').trim() || 'translate(0px,0px) scale(1) rotate(0deg)';

    function setVeo(val){
      document.documentElement.style.setProperty('--veo', val);
      localStorage.setItem(STORAGE_KEY, val);
    }
    function loadVeo(){
      const saved = localStorage.getItem(STORAGE_KEY);
      const val = saved || defaultVeo;
      input.value = val;
      document.documentElement.style.setProperty('--veo', val);
    }

    input.addEventListener('input', () => {
      // применяем «как есть» — одна переменная управляет всем
      setVeo(input.value.trim());
    });

    copyBtn.addEventListener('click', async () => {
      const css = `:root{ --veo: ${input.value.trim()}; }`;
      try{
        await navigator.clipboard.writeText(css);
        copyBtn.textContent = 'Скопировано!';
        setTimeout(() => copyBtn.textContent = 'Скопировать CSS', 1200);
      }catch{
        prompt('Скопируйте CSS вручную:', css);
      }
    });

    resetBtn.addEventListener('click', () => {
      input.value = defaultVeo;
      setVeo(defaultVeo);
    });

    /* ========= Предзагрузка ========= */
    const preloadImages = (srcs) => Promise.all(srcs.map(s => new Promise(res => {
      const im = new Image(); im.onload = im.onerror = () => res(); im.src = s;
    })));
    const preloadVideo = (v) => new Promise(res => {
      if (!v) return res();
      const ready = () => { v.removeEventListener('canplaythrough', ready); v.removeEventListener('loadeddata', ready); res(); };
      if (v.readyState >= 3) return res();
      v.addEventListener('canplaythrough', ready, { once:true });
      v.addEventListener('loadeddata', ready, { once:true });
      try { v.load(); } catch(e) {}
    });

    /* ========= Анимация ========= */
    function buildTimeline(){
      const tl = gsap.timeline({ defaults:{ ease:'power3.out' } });
      gsap.set('.device', { opacity:0, yPercent:4, scale:0.985, rotateZ:-1, filter:'blur(6px)' });
      gsap.set(['.s1','.s2','.s3','.s4','.s5','.s6'], { opacity:0, yPercent:3, rotateX:4, rotateZ:-1, scale:0.99 });
      gsap.set('.veo', { opacity:0 });

      tl.to('.device', { opacity:1, yPercent:0, scale:1, rotateZ:0, filter:'blur(0px)', duration:0.55, ease:'back.out(1.6)' });

      ['.s1','.s2','.s3','.s4','.s5','.s6'].forEach((sel, i) => {
        tl.to(sel, { opacity:1, yPercent:0, rotateX:0, rotateZ:0, scale:1, duration:0.42, ease:'back.out(1.4)' }, i===0 ? '-=0.15' : '-=0.10')
          .to(sel, { scale:1.01, duration:0.10 })
          .to(sel, { scale:1.00, duration:0.12 }, '-=0.05');
      });

      tl.fromTo('#stage',
        { filter:'drop-shadow(0 20px 60px rgba(0,0,0,.45))' },
        { filter:'drop-shadow(0 40px 120px rgba(0,0,0,.55))', duration:0.45 }, '-=0.2'
      );

      tl.add('videoIn');
      tl.call(() => {
        if (!video) return;
        try { video.currentTime = 0; } catch(e) {}
        const p = video.play?.();
        if (p && typeof p.catch === 'function') p.catch(() => {});
      }, null, 'videoIn');
      tl.to('.veo', { opacity:1, duration:0.45 }, 'videoIn');

      return tl;
    }

    /* ========= Инициализация ========= */
    async function init(){
      loadVeo(); // подтянуть сохранённую единственную настройку

      if (prefersReduced){
        gsap.set(layers, { opacity:0, clearProps:'transform,filter' });
        gsap.set('.device, .s6', { opacity:1 });
        if (video) video.style.display = 'none';
        document.querySelector('.one-var').style.display = 'none';
        document.getElementById('replay').style.display = 'none';
        return;
      }

      await preloadImages(layers.filter(l => l.tagName === 'IMG').map(l => l.currentSrc || l.src));
      await preloadVideo(video);

      const tl = buildTimeline();

      const restart = () => {
        if (video){ try { video.pause(); video.currentTime = 0; } catch(e){} }
        tl.restart();
      };
      document.getElementById('replay').addEventListener('click', restart);

      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => e.isIntersecting && restart());
      }, { threshold:0.4 });
      io.observe(document.getElementById('hero'));
    }

    init();
  })();
  </script>
</body>
</html>
