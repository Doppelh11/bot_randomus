<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карточка + CTR</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --fg:#fff; --muted:#b5b6bf; --maxw:1200px;

      --w-ones:1.05ch;
      --w-tenth:0.95ch;
      --digits-offset:0.2em;
      --dot-top:-0.25em;

      --ctr-label-size: clamp(20px, 3.2vw, 32px);
      --ctr-digit-size: clamp(28px, 4.8vw, 58px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:#f0f0f0;}
    .wrap{max-width:var(--maxw); margin:auto; padding:clamp(20px,4vw,64px)}

    .ctr-bar{display:flex; justify-content:center; margin-bottom:14px;}
    .ctr-row{display:flex; align-items:flex-end; gap:12px;}
    .ctr-label{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:800; letter-spacing:.14em; text-transform:uppercase; font-size: var(--ctr-label-size); line-height:1;}
    .slots{display:inline-flex; align-items:flex-end; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:800; font-variant-numeric: tabular-nums; font-size: var(--ctr-digit-size); line-height:1; color:var(--fg);}
    .digits{display:inline-flex; align-items:flex-end; gap:0.12ch; transform: translateY(var(--digits-offset));}
    .col{height:auto; overflow:hidden; position:relative; vertical-align:baseline;}
    .col-ones{width:var(--w-ones);}
    .col-tenth{width:var(--w-tenth);}
    .reel{position:absolute; left:0; top:0; will-change:transform; display:flex; flex-direction:column;}
    .reel span{display:block; height:1em; width:1ch; line-height:1; text-align:center;}
    .dot{display:inline-block; font-size:.62em; line-height:1; position:relative; top:var(--dot-top); margin:0 0.08ch; opacity:.9;}
    .pct{opacity:.95; font-size:.85em; margin-left:0.18ch; position:relative; top:var(--pct-top, -0.17em);}

    .digits.celebrate .reel span{
      background: linear-gradient(90deg,#FF7A00 0%,#FFC247 28%,#FFF2D6 52%,#FFB088 78%,#FF7A00 100%);
      background-size: 220% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: flow 3.6s ease-in-out infinite;
    }
    .digits.celebrate{animation: pulse 2.8s ease-in-out infinite; transform-origin: left bottom;}
    @keyframes flow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @keyframes pulse{0%,100%{ transform: translateY(var(--digits-offset)) scale(1) }50%{ transform: translateY(calc(var(--digits-offset) - 0.01em)) scale(1.04) }}

    /* ===== сцена ===== */
    .stage{
      position:relative; width:100%; max-width:760px;
      aspect-ratio: 2048 / 1828;
      margin-inline:auto; isolation:isolate;
      filter:drop-shadow(0 40px 120px rgba(0,0,0,.55));
      perspective:1200px; contain:layout paint;
      cursor:default;
      background: transparent;
    }
    .layer{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:contain;
      transform-style:preserve-3d; backface-visibility:hidden;
      will-change:transform,opacity,filter; opacity:0;
    }
    /* десктопное видео — вернуть cover */
    .veo{
      pointer-events:none; width:100%; height:100%;
      object-fit:cover;
      object-position:50% 50%;
      opacity:0; will-change:opacity;
    }
    .veo.apng{ display:none; }

    /* --- MOBILE-ONLY: APNG вместо видео и точное совпадение кадра --- */
    @media (pointer: coarse), (max-width: 820px){
      video.veo{ display:none !important; }
      .veo.apng{ display:block !important; object-fit:contain; }

      .s1,.s2,.s3,.s4,.s5,
      .veo.apng{
        transform: translateZ(0) scale(1.006);
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="ctr-bar">
      <div class="ctr-row">
        <div class="ctr-label">CTR</div>
        <div class="slots" aria-label="CTR">
          <div class="digits" id="digits">
            <div class="col col-ones"><div class="reel" id="ones"></div></div>
            <span class="dot">.</span>
            <div class="col col-tenth"><div class="reel" id="tenths"></div></div>
            <span class="pct">%</span>
          </div>
        </div>
      </div>
    </div>

    <div class="stage" id="stage" aria-hidden="true">
      <img class="layer device" src="assets/step1.png" alt="tablet frame">
      <img class="layer s1" src="assets/step2.png" alt="">
      <img class="layer s2" src="assets/step3.png" alt="">
      <img class="layer s3" src="assets/step4.png" alt="">
      <img class="layer s4" src="assets/step5.png" alt="">
      <img class="layer s5" src="assets/step6.png" alt="">
      <!-- Десктоп -->
      <video class="layer veo" id="veo" muted playsinline preload="auto" poster="assets/step6.png">
        <source src="assets/veo.webm#t=0.001" type="video/webm">
        <source src="assets/veo.mp4#t=0.001"  type="video/mp4">
      </video>
      <!-- Мобильный APNG -->
      <img class="layer veo apng" id="veo_apng" src="assets/veo.apng" alt="" aria-hidden="true">
    </div>
  </div>

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>
  <script>
  (() => {
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const video   = document.getElementById('veo');
    const apng    = document.getElementById('veo_apng');
    const isMobile = window.matchMedia('(pointer: coarse), (max-width: 820px)').matches;
    const useAPNG = isMobile;

    const onesReel   = document.getElementById('ones');
    const tenthsReel = document.getElementById('tenths');
    const digitsBox  = document.getElementById('digits');
    const DIGITS_LOOP = 8;
    const ctrPoints = [1.9, 2.3, 2.6, 3.3, 3.6, 4.7];
    const onesSeq     = ctrPoints.map(v => Math.floor(v));
    const tenthsSeq   = ctrPoints.map(v => Math.round((v%1)*10));
    let lineH = 0;
    const snap = v => Math.round(v);

    function buildReel(el){const frag=document.createDocumentFragment();for (let k=0;k<DIGITS_LOOP;k++){for (let d=0; d<=9; d++){const s=document.createElement('span'); s.textContent=d; frag.appendChild(s);}}el.innerHTML=''; el.appendChild(frag);}
    function measureAndFit(){const probe=onesReel.querySelector('span')||tenthsReel.querySelector('span'); lineH=probe?probe.getBoundingClientRect().height:0; const slotH=Math.round(lineH*1.25); document.querySelectorAll('.col').forEach(c=>{c.style.height=slotH+'px';}); const topPad=Math.round((slotH-lineH)/2); document.querySelectorAll('.reel').forEach(r=>{r.style.top=topPad+'px';});}
    function setIndex(el,index,immediate=false){const y=snap(-index*lineH); if(immediate) gsap.set(el,{y}); else gsap.to(el,{y,duration:0.5,ease:'power2.out'});}
    function spinTo(el,toIndex,dur=0.5,ease='power3.out'){const over=0.18*lineH; const y1=snap(-toIndex*lineH-over); const y2=snap(-toIndex*lineH); const tl=gsap.timeline(); tl.to(el,{y:y1,duration:dur*0.75,ease}).to(el,{y:y2,duration:dur*0.25,ease:'power2.out'}); return tl;}

    function buildTimeline(){
      const tl=gsap.timeline({defaults:{ease:'power3.out'}});
      gsap.set('.device',{opacity:0,yPercent:4,scale:0.985,rotateZ:-1,filter:'blur(6px)'});
      gsap.set(['.s1','.s2','.s3','.s4','.s5'],{opacity:0,yPercent:3,rotateX:4,rotateZ:-1,scale:0.99});
      gsap.set('.veo',{opacity:0});
      tl.to('.device',{opacity:1,yPercent:0,scale:1,rotateZ:0,filter:'blur(0px)',duration:0.55,ease:'back.out(1.6)'});
      const sels=['.s1','.s2','.s3','.s4','.s5'];
      sels.forEach((sel,i)=>{
        tl.to(sel,{opacity:1,yPercent:0,rotateX:0,rotateZ:0,scale:1,duration:0.42,ease:'back.out(1.4)'},i===0?'-=0.15':'-=0.10')
          .to(sel,{scale:1.01,duration:0.10})
          .to(sel,{scale:1.00,duration:0.12},'-=0.05');
        if (i < ctrPoints.length-2){
          const stepIdx=i+1; const onesIdx=stepIdx*10+onesSeq[stepIdx]; const tenthsIdx=stepIdx*10+tenthsSeq[stepIdx]; const label=`ctr_${stepIdx}`;
          tl.add(label,'>-0.02');
          tl.add(spinTo(onesReel,onesIdx,0.5,'power3.out'),label);
          tl.add(spinTo(tenthsReel,tenthsIdx,0.5,'power3.out'),`${label}+=0.06`);
        }
      });
      tl.fromTo('#stage',{filter:'drop-shadow(0 20px 60px rgba(0,0,0,.45))'},{filter:'drop-shadow(0 40px 120px rgba(0,0,0,.55))',duration:0.45},'-=0.2');
      tl.add('switchToVideo');
      tl.call(()=>{
        if(!useAPNG){
          try{video.currentTime=0;}catch(e){} const p=video.play?.(); if(p&&p.catch)p.catch(()=>{});
        } else {
          gsap.to(['.device','.s1','.s2','.s3','.s4','.s5'],{opacity:0,duration:0.45});
          gsap.to(apng,{opacity:1,duration:0.45});
        }
      },null,'switchToVideo');
      if(!useAPNG){
        tl.to(['.device','.s1','.s2','.s3','.s4','.s5'],{opacity:0,duration:0.5},'switchToVideo');
        tl.to(video,{opacity:1,duration:0.5},'switchToVideo');
      }
      return tl;
    }

    function scheduleFinalDuringPlayback(){
      let fired=false;
      const doFinal=()=>{if(fired)return; fired=true; const finalOnesIdx=5*10+Math.floor(ctrPoints[5]); const finalTenthsIdx=5*10+Math.round((ctrPoints[5]%1)*10); const tl=gsap.timeline(); tl.add(spinTo(onesReel,finalOnesIdx,0.55,'power3.out')).add(spinTo(tenthsReel,finalTenthsIdx,0.55,'power3.out'),'+=0.08'); digitsBox.classList.add('celebrate');};
      if(!useAPNG){
        if(!isFinite(video.duration)||video.duration===0){setTimeout(doFinal,700); return;}
        const mid=video.duration*0.5;
        const onTime=()=>{if(video.currentTime>=mid){video.removeEventListener('timeupdate',onTime); doFinal();}};
        video.addEventListener('timeupdate',onTime,{passive:true});
      } else {
        const MOBILE_APNG_DURATION=5.0;
        setTimeout(doFinal,MOBILE_APNG_DURATION*500);
      }
    }

    async function init(){
      buildReel(onesReel); buildReel(tenthsReel);
      requestAnimationFrame(()=>{measureAndFit(); const startOnesIdx=0*10+Math.floor(ctrPoints[0]); const startTenthsIdx=0*10+Math.round((ctrPoints[0]%1)*10); setIndex(onesReel,startOnesIdx,true); setIndex(tenthsReel,startTenthsIdx,true);});
      if(prefersReduced){gsap.set(document.querySelectorAll('.layer'),{opacity:0,clearProps:'transform,filter'}); gsap.set('.veo',{opacity:1}); requestAnimationFrame(()=>{const finalOnesIdx=5*10+Math.floor(ctrPoints[5]); const finalTenthsIdx=5*10+Math.round((ctrPoints[5]%1)*10); setIndex(onesReel,finalOnesIdx,true); setIndex(tenthsReel,finalTenthsIdx,true); digitsBox.classList.add('celebrate');}); return;}
      await Promise.all(['assets/step1.png','assets/step2.png','assets/step3.png','assets/step4.png','assets/step5.png','assets/step6.png'].map(s=>new Promise(res=>{const im=new Image(); im.onload=im.onerror=()=>res(); im.src=s;})));
      const tl=buildTimeline();
      if(!useAPNG){if(video.readyState>=1) scheduleFinalDuringPlayback(); else video.addEventListener('loadedmetadata',scheduleFinalDuringPlayback,{once:true});} else {scheduleFinalDuringPlayback();}
    }
    init();
  })();
  </script>
</body>
</html>
