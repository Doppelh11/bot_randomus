<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hero — сборка + хвост Veo3 (без раннего появления)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{ --bg:#0c0d10; --fg:#fff; --muted:#b5b6bf; --maxw:1200px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:radial-gradient(1200px 900px at 20% 20%, #171924 0, #0f1118 50%, #0c0d10 100%);
    }
    .wrap{max-width:var(--maxw); margin:auto; padding:clamp(20px,4vw,64px)}
    .hero{display:grid; grid-template-columns:1.1fr 0.9fr; align-items:center; gap:clamp(20px,5vw,80px); min-height:90svh;}
    @media (max-width:960px){ .hero{grid-template-columns:1fr; min-height:auto} .copy{text-align:center; order:-1;} }
    .copy h1{margin:0 0 .4em; line-height:1.05; font-weight:800; font-size:clamp(28px,6vw,62px); letter-spacing:-.02em}
    .copy p{margin:0 0 1.25rem; color:var(--muted); font-size:clamp(16px,2.3vw,20px)}
    .btn{appearance:none; border:none; background:#ffffff10; color:#fff; padding:12px 18px; border-radius:16px; font-weight:600; cursor:pointer; backdrop-filter:blur(6px); transition:transform .15s ease, background .2s ease;}
    .btn:hover{transform:translateY(-1px); background:#ffffff18}
    .btn:active{transform:translateY(0)}

    /* ===== Stage ===== */
    .stage{
      position:relative; width:100%; max-width:760px;
      aspect-ratio:2048/1828; /* точное соотношение ваших PNG */
      margin-inline:auto; isolation:isolate;
      filter:drop-shadow(0 40px 120px rgba(0,0,0,.55));
      perspective:1200px; contain:layout paint;
    }
    .layer{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:contain; transform-style:preserve-3d; backface-visibility:hidden;
      will-change:transform,opacity,filter; opacity:0;
    }

    /* Мокап с дыркой (поверх всего, режет край видео) */
    .mock-top{
      z-index: 10; opacity: 1 !important; /* всегда виден */
      pointer-events:none;
    }

    /* Класс для видео (добавляется динамически). Без clip-path — режет мокап */
    .tail{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; object-position:50% 50%;
      opacity:0; visibility:hidden; pointer-events:none;
      z-index:5; /* под мокапом, над слайдами */
      transform: translateZ(0);
    }
    /* Fallback для mp4/без альфы (Safari и пр.) */
    .tail.noalpha{ mix-blend-mode: screen; filter: brightness(0.95) contrast(1.05); }

    .hint{ text-align:center; color:#a7aab8; margin-top:22px; font-size:13px; opacity:.75 }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero" id="hero">
      <div class="stage" id="stage" aria-hidden="true">
        <!-- Нижняя рамка/планшет (на время сборки) -->
        <img class="layer device" src="assets/step1.png" alt="tablet frame">

        <!-- 6 экранных кадров -->
        <img class="layer s1" src="assets/step2.png" alt="">
        <img class="layer s2" src="assets/step3.png" alt="">
        <img class="layer s3" src="assets/step4.png" alt="">
        <img class="layer s4" src="assets/step5.png" alt="">
        <img class="layer s5" src="assets/step6.png" alt="">
        <img class="layer s6" src="assets/step7.png" alt="">

        <!-- ВЕРХНИЙ мокап с прозрачным окном (остаётся и во время видео) -->
        <img class="mock-top" src="assets/mockup.png" alt="mockup frame (transparent screen cutout)">
      </div>

      <div class="copy">
        <h1>Карточка «оживает»</h1>
        <p>7 PNG → плавный переход на Veo3-видео. Видео добавляется только в финале, рамка остаётся.</p>
        <button class="btn" id="replay">Повторить</button>
        <div class="hint">Файлы в <code>assets/</code>: <code>step1.png…step7.png, mockup.png, veo-tail.webm/mp4</code>.</div>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>
  <script>
  (() => {
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    const replayBtn = document.getElementById('replay');
    const stage = document.getElementById('stage');

    const SLIDES = ['.s1','.s2','.s3','.s4','.s5','.s6'];
    const HIDE_DEVICE_ON_TAIL = true;   // прячем нижнюю рамку-«step1» на время видео (сверху остаётся mockup.png)

    const preload = (srcs) => Promise.all(srcs.map(s => new Promise(res => {
      const im = new Image(); im.onload = im.onerror = () => res(); im.src = s;
    })));

    // Создание видео-элемента только в момент показа
    function createTailVideo(){
      const v = document.createElement('video');
      v.setAttribute('playsinline','');
      v.setAttribute('muted','');
      v.setAttribute('preload','auto');
      v.className = 'tail';
      // Источники
      const sWebm = document.createElement('source');
      sWebm.src = 'assets/veo-tail.webm'; sWebm.type = 'video/webm';
      const sMp4 = document.createElement('source');
      sMp4.src = 'assets/veo-tail.mp4'; sMp4.type = 'video/mp4';
      v.appendChild(sWebm); v.appendChild(sMp4);
      return v;
    }

    function buildTimeline(){
      const tl = gsap.timeline({ defaults:{ ease:'power3.out' } });

      // стартовые состояния
      gsap.set('.device', { opacity:0, yPercent:4, scale:0.985, rotateZ:-1, filter:'blur(6px)' });
      gsap.set(SLIDES.join(','), { opacity:0, yPercent:3, rotateX:4, rotateZ:-1, scale:0.99 });

      // планшет «приземляется»
      tl.to('.device', { opacity:1, yPercent:0, scale:1, rotateZ:0, filter:'blur(0px)', duration:0.55, ease:'back.out(1.6)' });

      // поочерёдно добавляем экраны
      SLIDES.forEach((sel, i) => {
        tl.to(sel, { opacity:1, yPercent:0, rotateX:0, rotateZ:0, scale:1, duration:0.42, ease:'back.out(1.4)' }, i===0?'-=0.15':'-=0.10')
          .to(sel, { scale:1.01, duration:0.10 })
          .to(sel, { scale:1.00, duration:0.12 }, '-=0.05');
      });

      // Переход на хвост-видео
      tl.add(() => {
        // создаём видео прямо сейчас и вставляем под мокап
        const tail = createTailVideo();
        // вставить ПЕРЕД верхним мокапом, чтобы мокап был сверху
        const mockTop = stage.querySelector('.mock-top');
        stage.insertBefore(tail, mockTop);

        // fallback на Safari: нет VP9-alfa → включаем blend
        if (!tail.canPlayType('video/webm; codecs="vp9"')) {
          tail.classList.add('noalpha');
        }
        tail.currentTime = 0;
        tail.play().catch(()=>{});

        // плавно показать видео и спрятать PNG
        gsap.to(tail, { opacity:1, visibility:'visible', duration:0.5, ease:'power2.out' });
        gsap.to(SLIDES.join(','), { autoAlpha:0, duration:0.45, ease:'power2.out' });
        if (HIDE_DEVICE_ON_TAIL) gsap.to('.device', { autoAlpha:0, duration:0.45, ease:'power2.out' });

        // по окончании — остановить на последнем кадре
        tail.addEventListener('ended', () => { tail.pause(); }, { once:true });

        // сохраним ссылку, чтобы сбрасывать при «Повторить»
        stage._tailVideo = tail;
      });

      return tl;
    }

    async function init(){
      if (prefersReduced){
        gsap.set('.device, .s6', { opacity:1 });
        // видео не создаём
        replayBtn.style.display = 'none';
        return;
      }

      const toPreload = ['.device', ...SLIDES].map(sel => (document.querySelector(sel)||{}).src).filter(Boolean);
      await preload(toPreload);

      const tl = buildTimeline();

      // Повтор: удаляем видео-элемент, возвращаем PNG
      replayBtn.addEventListener('click', () => {
        if (stage._tailVideo){
          stage._tailVideo.pause();
          stage._tailVideo.remove();
          stage._tailVideo = null;
        }
        gsap.set(SLIDES.join(','), { autoAlpha:1 });
        gsap.set('.device', { autoAlpha:1 });
        tl.restart();
      });

      // Авто-старт при появлении
      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          if (e.isIntersecting){
            if (stage._tailVideo){
              stage._tailVideo.pause();
              stage._tailVideo.remove();
              stage._tailVideo = null;
            }
            gsap.set(SLIDES.join(','), { autoAlpha:1 });
            gsap.set('.device', { autoAlpha:1 });
            tl.restart();
          }
        });
      }, { threshold:0.4 });
      io.observe(document.getElementById('hero'));
    }

    init();
  })();
  </script>
</body>
</html>
