<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карточка + CTR</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --fg:#fff; --muted:#b5b6bf; --maxw:1200px;
      --w-ones:1.05ch; --w-tenth:0.95ch;
      --digits-offset:0.2em; --dot-top:-0.25em;
      --ctr-label-size: clamp(20px, 3.2vw, 32px);
      --ctr-digit-size: clamp(28px, 4.8vw, 58px);
      --overscan: 1.006; /* общий для steps и APNG (только мобилка) */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:#000;}
    .wrap{max-width:var(--maxw); margin:auto; padding:clamp(20px,4vw,64px)}

    .ctr-bar{display:flex; justify-content:center; margin-bottom:14px;}
    .ctr-row{display:flex; align-items:flex-end; gap:12px;}
    .ctr-label{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:800; letter-spacing:.14em; text-transform:uppercase; font-size: var(--ctr-label-size); line-height:1;}
    .slots{display:inline-flex; align-items:flex-end; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:800; font-variant-numeric: tabular-nums; font-size: var(--ctr-digit-size); line-height:1; color:var(--fg);}
    .digits{display:inline-flex; align-items:flex-end; gap:0.12ch; transform: translateY(var(--digits-offset));}
    .col{height:auto; overflow:hidden; position:relative; vertical-align:baseline;}
    .col-ones{width:var(--w-ones);} .col-tenth{width:var(--w-tenth);}
    .reel{position:absolute; left:0; top:0; will-change:transform; display:flex; flex-direction:column;}
    .reel span{display:block; height:1em; width:1ch; line-height:1; text-align:center;}
    .dot{display:inline-block; font-size:.62em; line-height:1; position:relative; top:var(--dot-top); margin:0 0.08ch; opacity:.9;}
    .pct{opacity:.95; font-size:.85em; margin-left:0.18ch; position:relative; top:var(--pct-top, -0.17em);}

    .digits.celebrate .reel span{
      background: linear-gradient(90deg,#FF7A00 0%,#FFC247 28%,#FFF2D6 52%,#FFB088 78%,#FF7A00 100%);
      background-size: 220% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: flow 3.6s ease-in-out infinite;
    }
    .digits.celebrate{animation: pulse 2.8s ease-in-out infinite; transform-origin: left bottom;}
    @keyframes flow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @keyframes pulse{0%,100%{ transform: translateY(var(--digits-offset)) scale(1) }50%{ transform: translateY(calc(var(--digits-offset) - 0.01em)) scale(1.04) }}

    /* ===== сцена ===== */
    .stage{
      position:relative; width:100%; max-width:760px;
      aspect-ratio: 2048 / 1828; /* эталонная пропорция шагов */
      margin-inline:auto; isolation:isolate;
      filter:drop-shadow(0 40px 120px rgba(0,0,0,.55));
      perspective:1200px; contain:layout paint;
      cursor:default; background: transparent;
    }
    .layer{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:contain; object-position:50% 50%;
      transform-style:preserve-3d; backface-visibility:hidden;
      transform-origin:50% 50%;
      will-change:transform,opacity,filter; opacity:0;
    }

    /* Десктоп-видео — cover как было */
    .veo{
      pointer-events:none; width:100%; height:100%;
      object-fit:cover; object-position:50% 50%;
      transform-origin:50% 50%;
      opacity:0; will-change:opacity;
    }
    .veo.apng{ display:none; }

    /* --- МОБИЛЬНЫЙ --- */
    @media (pointer: coarse), (max-width: 820px){
      video.veo{ display:none !important; }
      .veo.apng{
        display:block !important;
        object-fit:contain; object-position:50% 50%;
        transform: translateZ(0) scale(var(--overscan));
        transform-origin:50% 50%;
        /* скрываем возможные letterbox через клип */
        clip-path: inset(var(--clip-t,0) var(--clip-r,0) var(--clip-b,0) var(--clip-l,0));
      }
      .s1,.s2,.s3,.s4,.s5{
        transform: translateZ(0) scale(var(--overscan));
        transform-origin:50% 50%;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="ctr-bar">
      <div class="ctr-row">
        <div class="ctr-label">CTR</div>
        <div class="slots" aria-label="CTR">
          <div class="digits" id="digits">
            <div class="col col-ones"><div class="reel" id="ones"></div></div>
            <span class="dot">.</span>
            <div class="col col-tenth"><div class="reel" id="tenths"></div></div>
            <span class="pct">%</span>
          </div>
        </div>
      </div>
    </div>

    <div class="stage" id="stage" aria-hidden="true">
      <img class="layer device" src="assets/step1.png" alt="tablet frame">
      <img class="layer s1" src="assets/step2.png" alt="">
      <img class="layer s2" src="assets/step3.png" alt="">
      <img class="layer s3" src="assets/step4.png" alt="">
      <img class="layer s4" src="assets/step5.png" alt="">
      <img class="layer s5" src="assets/step6.png" alt="">
      <!-- Десктоп -->
      <video class="layer veo" id="veo" muted playsinline preload="auto" poster="assets/step6.png">
        <source src="assets/veo.webm#t=0.001" type="video/webm">
        <source src="assets/veo.mp4#t=0.001"  type="video/mp4">
      </video>
      <!-- Мобильный APNG: не задаём src заранее, только data-src -->
      <img class="layer veo apng" id="veo_apng" data-src="assets/veo.apng" alt="" aria-hidden="true">
    </div>
  </div>

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>
  <script>
  (() => {
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const REF_W = 2048, REF_H = 1828;
    const video   = document.getElementById('veo');
    let   apng    = document.getElementById('veo_apng'); // может переопределиться после замены узла
    const isMobile = window.matchMedia('(pointer: coarse), (max-width: 820px)').matches;
    const useAPNG = isMobile;

    const onesReel   = document.getElementById('ones');
    const tenthsReel = document.getElementById('tenths');
    const digitsBox  = document.getElementById('digits');
    const DIGITS_LOOP = 8;
    const ctrPoints = [1.9, 2.3, 2.6, 3.3, 3.6, 4.7];
    const onesSeq     = ctrPoints.map(v => Math.floor(v));
    const tenthsSeq   = ctrPoints.map(v => Math.round((v%1)*10));
    let lineH = 0;
    const snap = v => Math.round(v);

    function buildReel(el){const frag=document.createDocumentFragment();for (let k=0;k<DIGITS_LOOP;k++){for (let d=0; d<=9; d++){const s=document.createElement('span'); s.textContent=d; frag.appendChild(s);}}el.innerHTML=''; el.appendChild(frag);}
    function measureAndFit(){const probe=onesReel.querySelector('span')||tenthsReel.querySelector('span'); lineH=probe?probe.getBoundingClientRect().height:0; const slotH=Math.round(lineH*1.25); document.querySelectorAll('.col').forEach(c=>{c.style.height=slotH+'px';}); const topPad=Math.round((slotH-lineH)/2); document.querySelectorAll('.reel').forEach(r=>{r.style.top=topPad+'px';});}
    function setIndex(el,index,immediate=false){const y=snap(-index*lineH); if(immediate) gsap.set(el,{y}); else gsap.to(el,{y,duration:0.5,ease:'power2.out'});}
    function spinTo(el,toIndex,dur=0.5,ease='power3.out'){const over=0.18*lineH; const y1=snap(-toIndex*lineH-over); const y2=snap(-toIndex*lineH); const tl=gsap.timeline(); tl.to(el,{y:y1,duration:dur*0.75,ease}).to(el,{y:y2,duration:dur*0.25,ease:'power2.out'}); return tl;}

    function updateCtrTo(stepIdx){
      const onesIdx   = stepIdx*10 + onesSeq[stepIdx];
      const tenthsIdx = stepIdx*10 + tenthsSeq[stepIdx];
      const tl=gsap.timeline();
      tl.add(spinTo(onesReel,onesIdx,0.5,'power3.out'));
      tl.add(spinTo(tenthsReel,tenthsIdx,0.5,'power3.out'), '+=0.06');
      return tl;
    }

    function applyApngClipToHideLetterbox(img){
      const nw = img.naturalWidth || REF_W;
      const nh = img.naturalHeight || REF_H;
      const apngAR = nw/nh;
      const refAR = REF_W/REF_H;

      if(Math.abs(apngAR - refAR) < 0.0001){
        img.style.setProperty('--clip-t','0'); img.style.setProperty('--clip-b','0');
        img.style.setProperty('--clip-l','0'); img.style.setProperty('--clip-r','0');
        return;
      }
      if(apngAR > refAR){
        const visibleW = REF_W/REF_H * nh;
        const side = Math.max(0, (nw - visibleW)/2 / nw) * 100;
        img.style.setProperty('--clip-l', side.toFixed(3)+'%');
        img.style.setProperty('--clip-r', side.toFixed(3)+'%');
        img.style.setProperty('--clip-t','0'); img.style.setProperty('--clip-b','0');
      } else {
        const visibleH = REF_H/REF_W * nw;
        const top = Math.max(0, (nh - visibleH)/2 / nh) * 100;
        img.style.setProperty('--clip-t', top.toFixed(3)+'%');
        img.style.setProperty('--clip-b', top.toFixed(3)+'%');
        img.style.setProperty('--clip-l','0'); img.style.setProperty('--clip-r','0');
      }
    }

    async function showApngFromZero(){
      const dataSrc = apng.getAttribute('data-src');
      if(!dataSrc) return;
      // 1) Подготовим новый URL с cache-buster, чтобы таймер точно был с нуля
      const url = dataSrc.split('?')[0] + '?v=' + Date.now();

      // 2) Предзагрузим вне DOM и дождёмся decode, чтобы не было моргания
      const pre = new Image();
      pre.decoding = 'sync';
      pre.src = url;
      try { await pre.decode(); } catch(e){ /* ignore */ }

      // 3) Создадим НОВЫЙ <img> со всеми классами — это гарантирует старт анимации с 0
      const fresh = document.createElement('img');
      fresh.className = apng.className; // "layer veo apng"
      fresh.id = apng.id;               // "veo_apng" (переназначим ссылку ниже)
      fresh.setAttribute('data-src', dataSrc);
      fresh.setAttribute('aria-hidden', 'true');
      fresh.style.opacity = '0';
      fresh.src = url;

      // Когда размеры известны — применим клип, чтобы убрать letterbox
      const onReady = ()=> applyApngClipToHideLetterbox(fresh);
      if(fresh.complete) onReady(); else fresh.addEventListener('load', onReady, {once:true});

      // 4) Заменим старый узел новым и обновим ссылку
      apng.replaceWith(fresh);
      apng = fresh;

      // 5) Плавно показать
      gsap.to(apng,{opacity:1,duration:0.45});
    }

    function buildTimeline(){
      const tl=gsap.timeline({defaults:{ease:'power3.out'}});
      gsap.set('.device',{opacity:0,yPercent:4,scale:0.985,rotateZ:-1,filter:'blur(6px)'});
      gsap.set(['.s1','.s2','.s3','.s4','.s5'],{opacity:0,yPercent:3,rotateX:4,rotateZ:-1,scale:0.99});
      gsap.set('.veo',{opacity:0});

      tl.to('.device',{opacity:1,yPercent:0,scale:1,rotateZ:0,filter:'blur(0px)',duration:0.55,ease:'back.out(1.6)'});

      const sels=['.s1','.s2','.s3','.s4','.s5'];
      sels.forEach((sel,i)=>{
        tl.to(sel,{opacity:1,yPercent:0,rotateX:0,rotateZ:0,scale:1,duration:0.42,ease:'back.out(1.4)'}, i===0?'-=0.15':'-=0.10')
          .to(sel,{scale:1.01,duration:0.10})
          .to(sel,{scale:1.00,duration:0.12},'-=0.05');
        const stepIdx=i+1; // 1..5, 0-й (1.9) задан на старте
        if(stepIdx < 5){
          tl.add(updateCtrTo(stepIdx), '>-0.02');
        } else {
          // Для 4.7 показываем заметно позже
          tl.to({}, {duration:0.18});
          tl.add(updateCtrTo(stepIdx), '>-0.02');
        }
      });

      tl.fromTo('#stage',{filter:'drop-shadow(0 20px 60px rgba(0,0,0,.45))'},{filter:'drop-shadow(0 40px 120px rgba(0,0,0,.55))',duration:0.45},'-=0.2');

      // Пауза после 4.7 перед стартом медиа
      tl.to({}, {duration:0.3}); // 300 мс

      tl.add('switchMedia');
      tl.call(async ()=>{
        if(!useAPNG){
          try{video.currentTime=0;}catch(e){} const p=video.play?.(); if(p&&p.catch)p.catch(()=>{});
          gsap.to(video,{opacity:1,duration:0.5});
          gsap.to(['.device','.s1','.s2','.s3','.s4','.s5'],{opacity:0,duration:0.5});
        } else {
          // Плавно погасить слои
          gsap.to(['.device','.s1','.s2','.s3','.s4','.s5'],{opacity:0,duration:0.45});
          // Показать APNG строго с 0-го кадра
          await showApngFromZero();
        }
      }, null, 'switchMedia');

      return tl;
    }

    function finalizeCelebrate(){
      const finalOnesIdx=5*10+Math.floor(ctrPoints[5]);
      const finalTenthsIdx=5*10+Math.round((ctrPoints[5]%1)*10);
      setIndex(onesReel,finalOnesIdx,false);
      setIndex(tenthsReel,finalTenthsIdx,false);
      digitsBox.classList.add('celebrate');
    }

    async function init(){
      buildReel(onesReel); buildReel(tenthsReel);
      // Ставим стартовое значение 1.9 (ctrPoints[0]) до начала анимации
      requestAnimationFrame(()=>{
        measureAndFit();
        const startOnesIdx=0*10+Math.floor(ctrPoints[0]);
        const startTenthsIdx=0*10+Math.round((ctrPoints[0]%1)*10);
        setIndex(onesReel,startOnesIdx,true);
        setIndex(tenthsReel,startTenthsIdx,true);
      });

      if(prefersReduced){
        gsap.set(document.querySelectorAll('.layer'),{opacity:0,clearProps:'transform,filter'});
        gsap.set('.veo',{opacity:1});
        requestAnimationFrame(()=>{
          const finalOnesIdx=5*10+Math.floor(ctrPoints[5]);
          const finalTenthsIdx=5*10+Math.round((ctrPoints[5]%1)*10);
          setIndex(onesReel,finalOnesIdx,true);
          setIndex(tenthsReel,finalTenthsIdx,true);
          digitsBox.classList.add('celebrate');
        });
        return;
      }

      // Предзагрузка PNG-слоёв (APNG не трогаем до свитча)
      const pngs = ['assets/step1.png','assets/step2.png','assets/step3.png','assets/step4.png','assets/step5.png','assets/step6.png'];
      await Promise.all(pngs.map(src => new Promise(res => { const im=new Image(); im.onload=im.onerror=()=>res(); im.src=src; })));

      const tl=buildTimeline();
      // Зафиксировать финал + celebrate после переключения
      tl.call(finalizeCelebrate, null, 'switchMedia+=0.1');
    }
    init();
  })();
  </script>
</body>
</html>
